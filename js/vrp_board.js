'use strict';(function(){var lastTime=0;var vendors=["webkit","moz"];for(var x=0;x<vendors.length&&!window.requestAnimationFrame;++x){window.requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame)window.requestAnimationFrame=function(callback,element){var currTime=(new Date).getTime();var timeToCall=Math.max(0,16-(currTime-lastTime));var id=
window.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);lastTime=currTime+timeToCall;return id};if(!window.cancelAnimationFrame)window.cancelAnimationFrame=function(id){clearTimeout(id)}})();function isMobile(){var ua=window.navigator.userAgent;return ua.match(/(iPad|iPhone|android)/i)}function isPhone(){var ua=window.navigator.userAgent;return ua.match(/iPhone/i)||ua.match(/android/i)&&isSmall()}
function isSmall(){var fact=1;if(typeof window.devicePixelRatio!=="undefined")fact=window.devicePixelRatio;var w=Math.floor(screen.width/fact),h=Math.floor(screen.height/fact);return w<=760||h<=440}function isAndroid(){return window.navigator.userAgent.match(/android/i)}function isChrome(){return window.navigator.userAgent.match(/chrome/i)}function min(x1,x2){return x1>x2?x2:x1}function max(x1,x2){return x1<x2?x2:x1}
function mixin(src,dst,override){for(var k in src)if(src.hasOwnProperty(k)){if(typeof dst[k]!=="undefined"&&!override)continue;dst[k]=src[k]}}function _assert(test,msg){if(!test){console.trace();if(msg)throw"assertion failed: "+msg;throw"assertion failed";}}if(typeof console=="undefined")console={log:function(str){},exception:function(str){}};if(!console.exception)console.exception=console.log;var BTN_LEFT=0;var _IE8=0;var _IE9=0;var mouseUpTarget=window;
if(window.attachEvent&&!window.addEventListener){BTN_LEFT=1;_IE8=1;mouseUpTarget=document.documentElement}if(document.documentMode)if(document.documentMode>8)_IE9=1;var mouseWheelEvent="mousewheel";if(/Firefox/i.test(navigator.userAgent))mouseWheelEvent="DOMMouseScroll";function stopPropagation(ev){if(ev.stopPropagation)ev.stopPropagation();if(ev.cancelBubble!=null)ev.cancelBubble=true}
function stopDefaultAction(ev){if(typeof ev.preventDefault!=="undefined")ev.preventDefault();else ev.returnValue=false}function disableEvent(ev){if(ev.preventDefault)ev.preventDefault();return false}function stopEvent(e){e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation()}function leftButtonPressed(ev){if(_IE8)return ev.button&1;else if(ev.buttons!=undefined)return ev.buttons&1;else return ev.which===1}
function testEventSupport(name,elname){var el=document.createElement(elname||"div");name="on"+name;var isSupported=name in el;if(!isSupported){el.setAttribute(name,"return;");isSupported=typeof el[name]=="function"}el=null;return isSupported}var haveMouseLeave=testEventSupport("mouseleave");function MouseLeave(node,handler){this.node=node;this.handler=handler;this.isOver=false}
MouseLeave.prototype={mousemove:function(ev){var isOver=mouseIsOver(ev,this.node);if(this.isOver&&!isOver){this.isOver=isOver;return this.handler(ev)}this.isOver=isOver},remove:function(){this.node=undefined;this.handler=undefined}};
function _bindEvent(el,eventName,eventHandler){var handler=function(e){var ev=e||window.event;return eventHandler(ev)};if(el.addEventListener){el.addEventListener(eventName,handler,false);return handler}else if(el.attachEvent){el.attachEvent("on"+eventName,handler);return handler}return}
function bindEvent(el,eventName,eventHandler){if(!haveMouseLeave&&eventName=="mouseleave"){var ml=new MouseLeave(el,eventHandler);return _bindEvent(window,"mousemove",function(ev){if(typeof ev==="number"&&ev==0)ml.remove();else ml.mousemove(ev)})}return _bindEvent(el,eventName,eventHandler)}
function _unbindEvent(el,eventName,eventHandler){if(!eventHandler)return undefined;if(el.removeEventListener)el.removeEventListener(eventName,eventHandler,false);else if(el.attachEvent)el.detachEvent("on"+eventName,eventHandler);return undefined}function unbindEvent(el,eventName,eventHandler){if(!eventHandler)return undefined;if(!haveMouseLeave&&eventName=="mouseleave"){eventHandler(0);return _unbindEvent(window,"mousemove",eventHandler)}return _unbindEvent(el,eventName,eventHandler)}
function $(x){return document.getElementById(x)}var xhrJsonResponseType="json";function _testXhrJson(){try{var r=new XMLHttpRequest;r.responseType="json"}catch(e){xhrJsonResponseType=""}}_testXhrJson();
function json_request(url,callback){setTimeout(function(){var r=new XMLHttpRequest;r.onload=function(){if(callback)try{var res=r.response;if(!res||typeof res!="object")res=JSON.parse(r.responseText);callback(res)}catch(e){return}};r.open("GET",url,true);r.responseType=xhrJsonResponseType;r.send()},0)}
function post_request(url,params,callback){setTimeout(function(){var r=new XMLHttpRequest;r.onreadystatechange=function(){if(r.readyState==4&&r.status==200)if(callback)try{var res=r.response;if(!res||typeof res!="object")res=JSON.parse(r.responseText);callback(res)}catch(e){return}};r.open("POST",url,true);r.setRequestHeader("Content-type","application/x-www-form-urlencoded; charset=UTF-8");r.responseType=xhrJsonResponseType;r.send(params)},0)}
function sync_request(url){var r=new XMLHttpRequest;r.open("GET",url,false);r.send();if(r.status===200)return JSON.parse(r.responseText);return}
function nodeOffset(node){if(_IE8||_IE9){var top=0,left=0;while(node&&!isNaN(node.offsetLeft)&&!isNaN(node.offsetTop)){top=top+node.offsetTop-node.scrollTop;left=left+node.offsetLeft-node.scrollLeft;node=node.offsetParent}return{top:top-document.documentElement.scrollTop,left:left-document.documentElement.scrollLeft}}var top=0,left=0;while(node!==document.body){if(node==null)return{top:0,left:0};top=top+node.offsetTop-node.scrollTop;left=left+node.offsetLeft-node.scrollLeft;node=node.offsetParent}return{top:top-
window.scrollY,left:left-window.scrollX}}function object_values(o){var res=[];for(var k in o)if(o.hasOwnProperty(k))res.push(o[k]);return res}function mouseIsOver(ev,node){if(isNaN(ev.clientX))return false;if(isNaN(ev.clientY))return false;var offs=nodeOffset(node);if(ev.clientX<offs.left)return false;if(ev.clientX>offs.left+node.clientWidth)return false;if(ev.clientY<offs.top)return false;if(ev.clientY>offs.top+node.clientHeight)return false;return true}
var TRANSLATIONS={"de":{"RESET BOARD":"NEUE KARTE","edit":"edit","fewer":"weniger","more":"mehr","Locations":"Orte","Vehicles":"Fahrer","depot":"Depot","clear all connections":"Verbindungen löschen","tour&nbsp;length":"Tour&nbsp;Länge","invalid solution":"Lösung ungültig","Solution is invalid":"Lösung ist ungültig","valid solution":"gültige Lösung","Solution is valid":"Lösung ist gültig","length":"Länge"}};var LANGUAGE="en";
function tr(msg){if(!TRANSLATIONS[LANGUAGE])return msg;var tmsg=TRANSLATIONS[LANGUAGE][msg];if(tmsg)return tmsg;return msg}function detect_language(){return navigator.languages&&navigator.languages[0]||navigator.language||navigator.userLanguage||"en"}
var cfg={act:{intersect:15,location:12,edge:12,edge_near_loc:5,conn_over_r:15,conn_over_d:30,autoconn:12,move_inact:12},edge:{width:3,flash_width:6},loc:{rad:10,rad_appear:13,rad_subtour:12,rad_connect:18},scene:{mindist:40,margin:30},cursor:{rad:35},font:{size:32},touch:{maxdist:10}};
(function(){var loc_scale=1.3;var act_scale=1.3;var edge_scale=1.2;var fact=1;var wfact=1;if(typeof window.devicePixelRatio!=="undefined"){if(window.devicePixelRatio<=1.5)fact=1/window.devicePixelRatio;else if(window.devicePixelRatio<=2)fact=.6;else fact=.7;wfact=1/window.devicePixelRatio}if(isMobile()){cfg.cursor.rad=45;loc_scale=1.5;act_scale=1.5;if(isPhone()){cfg.cursor.rad=60;loc_scale=1.4;act_scale=3}}else if(touchMode())act_scale=1.5;if(screen.width*wfact>1900)cfg.scene.mindist=cfg.scene.mindist*
1.5;loc_scale=loc_scale*fact;act_scale=act_scale*fact;edge_scale=edge_scale*fact;cfg.cursor.rad=cfg.cursor.rad*fact;cfg.scene.mindist=cfg.scene.mindist/fact;for(var k in cfg.act)cfg.act[k]=cfg.act[k]*act_scale;for(var k in cfg.loc)cfg.loc[k]=cfg.loc[k]*loc_scale;for(var k in cfg.scene)cfg.scene[k]=cfg.scene[k]*loc_scale;for(var k in cfg.font)cfg.font[k]=cfg.font[k]*loc_scale;for(var k in cfg.edge)cfg.edge[k]=cfg.edge[k]*edge_scale;cfg.font.size=Math.floor(cfg.font.size+.5);cfg.act.sq_intersect=cfg.act.intersect*
cfg.act.intersect;cfg.act.sq_move_inact=cfg.act.move_inact*cfg.act.move_inact})();
function EventQueue(){var events=[];var listeners=undefined;this.create=function(name,data){if(!listeners)return;if(!data)data={};data.action=name;events.push(data)};this.fire_events=function(){if(this._processing)return;this._processing=1;while(listeners&&events.length){var ev=events.slice();events=[];for(var i=0;i<listeners.length;i++)listeners[i](ev)}delete this._processing};this.discard_events=function(){events=[]};this.notify=function(name,data){if(!listeners)return;if(!data)data={};data.action=
name;for(var i=0;i<listeners.length;i++)listeners[i]([data])};this.register=function(listener){if(!listeners)listeners=[listener];else listeners.push(listener);return listener};this.unregister=function(listener){for(var i=0;i<listeners.length;i++)if(listeners[i]===listener){listeners.splice(i,1);if(listeners.length==0)listeners=undefined;return}};this.clients=function(){return this.listeners?this.listeners.length:0};this.close=function(){listeners=undefined;events=undefined}}
var geom=function(){function Vector(x,y){this.x=x;this.y=y}Vector.prototype={sub:function(v){return vec(this.x-v.x,this.y-v.y)},add:function(v){return vec(this.x+v.x,this.y+v.y)},mul:function(s){return vec(this.x*s,this.y*s)},div:function(s){return vec(this.x/s,this.y/s)},dot:function(v){return this.x*v.x+this.y*v.y},norm:function(){return vec(-this.y,this.x)},sq_dist:function(v){var dx=this.x-v.x,dy=this.y-v.y;return dx*dx+dy*dy},dist:function(v){return Math.sqrt(this.sq_dist(v))},len:function(){return Math.sqrt(this.x*
this.x+this.y*this.y)},project:function(edge){var v1=edge.l1,v2=edge.l2;var dir=v1.sub(v2);var lambda=this.sub(v2).dot(dir)/dir.dot(dir);if(lambda>=0&&lambda<=1){var p=v2.add(dir.mul(lambda));var res=new Vector(p.x,p.y);res.lambda=lambda;return Object.freeze(res)}},project_angle:function(v){var raw=Math.atan2(this.y,this.x)-Math.atan2(v.y,v.x);if(raw<0)raw+=2*Math.PI;if(raw>Math.PI)raw=2*Math.PI-raw;if(2*raw>Math.PI)raw=Math.PI-raw;return raw},toString:function(){return"["+this.x.toFixed(3)+","+this.y.toFixed(3)+
"]"},in_circle:function(edge){var v1=edge.l1,v2=edge.l2;var mean=v2.add(v1).mul(.5);if(mean.sq_dist(this)<mean.sq_dist(v2))return true;return false}};function Rect(ul,lr){this.ul=ul;this.lr=lr;this.width=lr.x-ul.x;this.height=lr.y-ul.y}function IXG(w,h,unit){this.width=w;this.height=h;this.unit=unit;this.cells=[]}IXG.prototype={for_each:function(callback){var c=this.cells;for(var i=0;i<c.length;i++){var ci=c[i];if(ci)for(var j=0;j<ci.length;j++)if(ci[j])for(var k=0;k<ci[j].length;k++)callback(ci[j][k])}},
resize:function(w,h){this.width=w;this.height=h},getcell:function(ix,iy){var c1=this.cells[ix];if(!c1)return;return c1[iy]},getall:function(list){if(!list)return;var res=[];for(var i=0;i<list.length;i++){var c=this.getcell(list[i].x,list[i].y);if(!c)continue;for(var j=0;j<c.length;j++)res.push(c[j])}return res},allocate:function(ix,iy){var c1=this.cells[ix];if(!c1){c1=[];this.cells[ix]=c1}var cell=c1[iy];if(cell)return cell;cell=[];c1[iy]=cell;return cell},locate:function(v){return{x:Math.floor(v.x/
this.unit),y:Math.floor(v.y/this.unit)}},constrain:function(v){return vec(v.x<0?0:v.x>this.width?this.width:v.x,v.y<0?0:v.y>this.height?this.height:v.y)},discard:function(){this.cells=[]},close:function(){this.cells=undefined},insert:function(pos,load){var cell=this.allocate(pos.x,pos.y);cell.push(load)},remove:function(pos,load){var c=this.getcell(pos.x,pos.y);for(var i=0;i<c.length;i++)if(c[i]==load){c.splice(i,1);return}},query_rect:function(r){var i_ul=this.locate(this.constrain(r.ul));var i_lr=
this.locate(this.constrain(r.lr));var ix_min=i_ul.x,ix_max=i_lr.x,iy_min=i_ul.y,iy_max=i_lr.y;var res=[];for(var ix=ix_min;ix<=ix_max;ix++){var cellsx=this.cells[ix];if(!cellsx)continue;for(var iy=iy_min;iy<=iy_max;iy++){var list=cellsx[iy];if(!list)continue;for(var i=0;i<list.length;i++)res.push(list[i])}}return res}};function GridIndex(w,h,unit){this.grid=new IXG(w,h,unit)}GridIndex.prototype={resize:function(w,h){this.grid.resize(w,h)},insert:function(v){var pos=this.grid.locate(v);this.grid.insert(pos,
v)},discard:function(){this.grid.discard()},remove:function(v){var pos=this.grid.locate(v);this.grid.remove(pos,v)},query_rect:function(r){var cands=this.grid.query_rect(r);var res=[];for(var i=0;i<cands.length;i++){var p=cands[i];if(p.x>r.ul.x&&p.x<r.lr.x&&p.y>r.ul.y&&p.y<r.lr.y)res.push(p)}if(res.length)return res}};function EdgeIndex(w,h,unit){this.grid=new IXG(w,h,unit)}var __edge_key_seq=0;EdgeIndex.prototype={_idist_abs:function(v1,v2){return Math.abs(v1.x-v2.x)+Math.abs(v1.y-v2.y)},_recursive_sample_edge:function(v1,
v2,iv1,iv2,res,level){var d=this._idist_abs(iv1,iv2);if(d==0)return;if(d==1){res.push(iv1);return}if(level>15&&d==2){res.push(iv1,{x:iv1.x,y:iv2.y},{x:iv2.x,y:iv1.y});return}var mid=v1.add(v2).mul(.5);var imid=this.grid.locate(mid);this._recursive_sample_edge(v1,mid,iv1,imid,res,++level);this._recursive_sample_edge(mid,v2,imid,iv2,res,++level)},quantize:function(e){var g=this.grid;var res=[];var iv1=g.locate(e.l1),iv2=g.locate(e.l2);this._recursive_sample_edge(e.l1,e.l2,iv1,iv2,res,0);res.push(iv2);
return res},insert:function(e){if(!e._index_key)e._index_key="__edge_key_"+__edge_key_seq++;var pos=this.quantize(e);for(var i=0;i<pos.length;i++)this.grid.insert(pos[i],e)},remove:function(e){var pos=this.quantize(e);for(var i=0;i<pos.length;i++)this.grid.remove(pos[i],e)},discard:function(){this.grid.discard()},close:function(){this.grid.close();delete this.grid},_unique_result:function(list){if(!list)return;var res=[];var unique_test={};for(var i=0;i<list.length;i++){var e=list[i];if(!unique_test[e._index_key]){unique_test[e._index_key]=
1;res.push(e)}}if(res.length)return res},query_rect:function(r){var cands=this.grid.query_rect(r);return this._unique_result(cands)},query_edge:function(e){var q=this.quantize(e);var cands=this.grid.getall(q);return this._unique_result(cands)},edge_rects:function(e){var res=this.quantize(e);var g=this.grid;var rects=[];for(var i=0;i<res.length;i++){var iv=res[i];var ul=vec(iv.x*g.unit,iv.y*g.unit);var lr=vec((iv.x+1)*g.unit,(iv.y+1)*g.unit);rects.push(new Rect(ul,lr))}return rects},resize:function(w,
h){if(w<this.grid.width||h<this.grid.height)this.grid.for_each(function(e){if(e.l1.x>w||e.l1.y>h)throw"resize error";if(e.l2.x>w||e.l2.y>h)throw"resize error";});this.grid.resize(w,h)}};return{EdgeIndex:EdgeIndex,GridIndex:GridIndex,Rect:Rect,Vector:Vector}}();function vec(x,y){var res=new geom.Vector(x,y);return Object.freeze(res)}function rect_around(v,w,h){var d=vec(w/2,(h?h:w)/2);return new geom.Rect(v.sub(d),v.add(d))}var VERY_SLOW=false;
function ANIM(sheet){var anim={};function _2hex(x){var s=x.toString(16);if(s.length==1)return"0"+s;return s}function is_color(x){return(""+x).charAt(0)=="#"}function is_vector(x){return typeof x==="object"&&typeof x.x!=="undefined"&&typeof x.y!=="undefined"}function normalize_color(x){if(x.length==4)x="#"+x.charAt(1)+x.charAt(1)+x.charAt(2)+x.charAt(2)+x.charAt(3)+x.charAt(3);else;return x}function scale_color(c0,c1,f){var r0=parseInt(c0.substr(1,2),16);var r1=parseInt(c1.substr(1,2),16);var r=Math.floor(r0+
(r1-r0)*f+.5);var g0=parseInt(c0.substr(3,2),16);var g1=parseInt(c1.substr(3,2),16);var g=Math.floor(g0+(g1-g0)*f+.5);var b0=parseInt(c0.substr(5,2),16);var b1=parseInt(c1.substr(5,2),16);var b=Math.floor(b0+(b1-b0)*f+.5);return"#"+_2hex(r)+_2hex(g)+_2hex(b)}function scale_vector(c0,c1,f){return vec(c0.x+(c1.x-c0.x)*f,c0.y+(c1.y-c0.y)*f)}function type_default(val){if(is_color(val))return"#000000";if(is_vector(val))return vec(0,0);return 0}function type_normalize(val){if(is_color(val))return normalize_color(val);
return val}function type_scalevalue(init,dest,fact){if(is_color(init))return scale_color(init,dest,fact);if(is_vector(init))return scale_vector(init,dest,fact);return init+(dest-init)*fact}function ends_with(str,suffix){return str.indexOf(suffix,str.length-suffix.length)!==-1}function copy_script(scr){var res={};for(var key in scr){if(!scr.hasOwnProperty(key))continue;res[key]=scr[key].slice()}return res}function save_values(obj,scr){var res={};for(var key in scr){if(!scr.hasOwnProperty(key))continue;
res[key]=obj[key]}return res}function restore_values(obj,v){for(var key in v)obj[key]=v[key]}function init_values(obj,script){var update={};for(var key in script){if(!script.hasOwnProperty(key))continue;var scr=script[key];if(ends_with(key,"$")){key=key.substr(0,key.length-1);obj[key]=type_normalize(scr[0]);scr.splice(0,1)}else if(typeof obj[key]==="undefined")obj[key]=type_default(scr[1]);else obj[key]=type_normalize(obj[key]);update[key]=scr}return update}anim.Director={scripts:[],cancel:function(x,
key){if(x){var s=this.scripts;for(var i=0;i<s.length;i++)if(s[i].obj===x)if(!key)s.splice(i--,1);else{var it=s[i].items;for(var j=0;j<it.length;j++)if(it[j].key===key)it.splice(j--,1)}}else this.scripts=[]},schedule:function(obj,script,callback){var items=[];var now=Date.now();script=init_values(obj,script);if(callback==="restart"){var _this=this;var sv=save_values(obj,script);var copy=copy_script(script);callback=function(){restore_values(obj,sv);_this.schedule(obj,copy,"restart")}}for(var key in script){if(!script.hasOwnProperty(key))continue;
var scr=script[key];var time=now;for(var j=1;j<scr.length;j+=3){scr[j]=type_normalize(scr[j]);time+=scr[j-1]*1E3;scr[j-1]=time;time+=scr[j+1]*1E3;scr[j+1]=time}items.push({key:key,scr:scr,obj:obj,init:obj[key]})}this.scripts.push({items:items,callback:callback,obj:obj});startAnimations()},step:function(time){if(this.scripts.length==0)return false;var callbacks=[];for(var i=0;i<this.scripts.length;i++){var items=this.scripts[i].items;var obj=this.scripts[i].obj;var removes=[];for(var j=0;j<items.length;j++){var it=
items[j];while(it.scr.length>=3){it.obj.dirty=true;if(time<it.scr[0])break;if(time>it.scr[2]){it.obj[it.key]=it.scr[1];it.obj.dirty=true;it.init=it.scr[1];it.scr.splice(0,3);continue}var fact=(time-it.scr[0])/(it.scr[2]-it.scr[0]);it.obj[it.key]=type_scalevalue(it.init,it.scr[1],fact);it.obj.dirty=true;break}if(it.scr.length<3)removes.push(j)}for(var k=removes.length-1;k>=0;k--)items.splice(removes[k],1);if(items.length===0){if(this.scripts[i].callback)callbacks.push([this.scripts[i].callback,this.scripts[i].obj]);
this.scripts.splice(i--,1)}}for(var i=0;i<callbacks.length;i++)callbacks[i][0](callbacks[i][1]);return true}};anim.Queue={queue:[],count:0,add:function(x,prio){x.dirty=true;if(!prio)prio=1;if(!this.queue[prio])this.queue[prio]=[];this.queue[prio].push(x);this.count++;startAnimations()},add_front:function(x){x.dirty=true;if(!this.queue[0])this.queue[0]=[];this.queue[0].unshift(x);this.count++;startAnimations()},empty:function(){return this.count==0},size:function(){return this.count},cancel:function(obj){if(obj){var q=
this.queue;for(var i=0;i<q.length;i++)if(q[i])for(var j=0;j<q[i].length;j++)if(q[i][j]===obj){q[i].splice(j,1);this.count--;return}}else{this.queue=[];this.count=0}},render:function(){var tmp=[],q=this.queue;sheet.frame_start();for(var i=0;i<q.length;i++)if(q[i])for(var j=0;j<q[i].length;j++){var item=q[i][j];if(item.dirty){item.render(sheet);if(!tmp[i])tmp[i]=[];tmp[i].push(item)}else this.count--;delete item.dirty}this.queue=tmp}};var run_handle;var _rate_time_sum=0;var _rate_count=0;var _last_switch=
Date.now();function test_slow_framerate(post,pre){var diff=post-pre;_rate_count++;_rate_time_sum+=diff;if(_rate_count>20){if(_rate_time_sum/_rate_count>50){VERY_SLOW=true;_last_switch=Date.now()}_rate_count=0;_rate_time_sum=0}}function test_fast_framerate(post,pre){var diff=post-pre;_rate_count++;_rate_time_sum+=diff;if(_rate_count>50){if(_rate_time_sum/_rate_count<35){VERY_SLOW=false;_last_switch=Date.now()}_rate_count=0;_rate_time_sum=0}}function anim_loop(){var time=Date.now();try{run_handle=requestAnimationFrame(anim_loop);
var more=anim.Director.step(time);anim.Queue.render();if(!more&&anim.Queue.empty()){cancelAnimationFrame(run_handle);run_handle=undefined}if(!VERY_SLOW)setTimeout(function(){test_slow_framerate(Date.now(),time)},0);else{var t=Date.now();if(t-_last_switch>5*60*1E3)setTimeout(function(){test_fast_framerate(Date.now(),time)},0)}}catch(x){console.exception(x);cancelAnimationFrame(run_handle)}}function startAnimations(){if(run_handle)return;run_handle=requestAnimationFrame(anim_loop)}return anim}
function GFX_CURSOR(anim){var m={};var director=anim.Director;var rqueue=anim.Queue;m.Grab=function(pos){this.pos=pos;var r0=cfg.cursor.rad;var d=Number((r0/35*2).toFixed(1));director.schedule(this,{alpha$:[.2,0,.6,1,0,.2,1],blue$:[200,0,230,1,0,200,1],radius$:[r0-d,0,r0+d,1,0,r0-d,1],stroke$:["#aaa",0,"#00f",1,0,"#aaa",1]},"restart");rqueue.add(this,3)};m.Grab.prototype={position:function(pos){this.pos=pos},stop:function(){director.cancel(this)},render:function(sheet){var ctx=sheet.actor_context(0);
ctx.beginPath();ctx.arc(this.pos.x,this.pos.y,this.radius,0,2*Math.PI);ctx.lineWidth=2*cfg.cursor.rad/35;ctx.strokeStyle=this.stroke;if(!VERY_SLOW){ctx.fillStyle="rgba(200,200,"+Math.floor(this.blue)+","+this.alpha+")";ctx.fill()}ctx.stroke()}};m.Bend=function(l1,l2,pos){this.pos=pos;this.l1=l1;this.l2=l2;var scale=cfg.cursor.rad/35;var h0=38*scale;var dh=2*scale;var w0=9*scale;var dw=2*scale;director.schedule(this,{boxwidth$:[w0-dw,0,w0+dw,.7,0,w0-dw,.7],boxheight$:[h0-dh,0,h0+dh,.7,0,h0-dh,.7]},
"restart");rqueue.add(this,3)};m.Bend.prototype={position:function(pos){this.pos=pos},stop:function(){director.cancel(this)},flip:function(l1,l2,alt){this.l1=l1;this.l2=l2;this.alt=alt},render:function(sheet){var ctx=sheet.actor_context(0);var pos=this.pos,l1=this.l1,l2=this.l2;ctx.save();ctx.beginPath();ctx.moveTo(l1.x,l1.y);ctx.lineTo(pos.x,pos.y);ctx.lineTo(l2.x,l2.y);ctx.lineCap="round";ctx.lineJoin="round";ctx.lineWidth=cfg.edge.width+2;if(!VERY_SLOW){ctx.strokeStyle="#888";ctx.stroke();ctx.lineWidth=
cfg.edge.width}ctx.strokeStyle=E_COLOR;ctx.stroke();ctx.beginPath();ctx.lineCap="butt";ctx.lineJoin="miter";if(!VERY_SLOW)ctx.fillStyle="rgba(0,0,255,0.6)";else ctx.fillStyle="#00f";var w=this.boxwidth;var h=this.boxheight;var r=cfg.cursor.rad*.9;ctx.rect(pos.x-r-w/2,pos.y-h/2,w,h);ctx.rect(pos.x+r-w/2,pos.y-h/2,w,h);ctx.rect(pos.x-h/2,pos.y-r-w/2,h,w);ctx.rect(pos.x-h/2,pos.y+r-w/2,h,w);ctx.fill();ctx.restore();if(this.alt){ctx=sheet.anim_tour_context();ctx.save();ctx.beginPath();ctx.moveTo(pos.x,
pos.y);ctx.lineTo(this.alt.x,this.alt.y);ctx.moveTo(this.l1.x,this.l1.y);ctx.lineTo(this.l2.x,this.l2.y);ctx.lineWidth=1;ctx.strokeStyle="#88f";ctx.stroke();ctx.restore()}}};m.Connect=function(start,pos){this.start=start;this.pos=pos;this.inter=[];director.schedule(this,{angle:[0,2,3]},"restart");rqueue.add(this,3)};m.Connect.prototype={position:function(pos){this.pos=pos},stop:function(){director.cancel(this)},connect:function(start){this.start=start},intersects:function(inter){this.inter=inter},
render:function(sheet){var ctx=sheet.actor_context(0);var start=this.start;var pos=this.pos;var angle=this.angle;ctx.save();ctx.beginPath();ctx.moveTo(start.x,start.y);ctx.lineTo(pos.x,pos.y);ctx.lineCap="round";ctx.lineWidth=cfg.edge.width+2;if(!VERY_SLOW){ctx.strokeStyle="#888";ctx.stroke();ctx.lineWidth=cfg.edge.width}ctx.strokeStyle=E_COLOR;ctx.stroke();if(!VERY_SLOW)ctx.strokeStyle="rgba(255,0,0,0.8)";else ctx.strokeStyle="#f00";ctx.lineWidth=cfg.cursor.rad*6/35;ctx.lineCap="butt";ctx.beginPath();
ctx.arc(pos.x,pos.y,cfg.cursor.rad,angle*Math.PI,(angle+.6)*Math.PI);ctx.stroke();ctx.beginPath();ctx.arc(pos.x,pos.y,cfg.cursor.rad,(.666+angle)*Math.PI,(.666+angle+.6)*Math.PI);ctx.stroke();ctx.beginPath();ctx.arc(pos.x,pos.y,cfg.cursor.rad,(1.333+angle)*Math.PI,(1.333+angle+.6)*Math.PI);ctx.stroke();if(!VERY_SLOW)for(var i=0;i<this.inter.length;i++){var ip=this.inter[i];ctx.beginPath();ctx.arc(ip.x,ip.y,5,0,2*Math.PI);ctx.lineWidth=3;ctx.strokeStyle="#d00";ctx.stroke()}ctx.restore()}};m.Intersect=
function(pos){this.pos=pos;director.schedule(this,{angle:[0,1,.5]},"restart");rqueue.add(this,3)};m.Intersect.prototype={position:function(pos){this.pos=pos},stop:function(){director.cancel(this)},render:function(sheet){var ctx=sheet.actor_context(0);ctx.lineWidth=cfg.cursor.rad*6/35;var a=this.angle*2*Math.PI;ctx.strokeStyle="#0f0";ctx.beginPath();ctx.arc(this.pos.x,this.pos.y,cfg.cursor.rad,a+.2*Math.PI,a+.8*Math.PI);ctx.stroke();ctx.beginPath();ctx.arc(this.pos.x,this.pos.y,cfg.cursor.rad,a+1.2*
Math.PI,a+1.8*Math.PI);ctx.stroke()}};m.Delete=function(pos){this.pos=pos;director.schedule(this,{angle:[0,-1,.5]},"restart");rqueue.add(this,3)};m.Delete.prototype={position:function(pos){this.pos=pos},stop:function(){director.cancel(this)},render:function(sheet){var ctx=sheet.actor_context(0);ctx.lineWidth=cfg.cursor.rad*6/35;var a=this.angle*2*Math.PI;ctx.strokeStyle="#f00";ctx.beginPath();ctx.arc(this.pos.x,this.pos.y,cfg.cursor.rad,a+.2*Math.PI,a+.8*Math.PI);ctx.stroke();ctx.beginPath();ctx.arc(this.pos.x,
this.pos.y,cfg.cursor.rad,a+1.2*Math.PI,a+1.8*Math.PI);ctx.stroke()}};m.Create=function(pos){this.pos=pos;this.color="#f00";this.angle=0;director.schedule(this,{angle:[0,2,3]},"restart");rqueue.add(this,3)};m.Create.prototype={position:function(pos){this.pos=pos},stop:function(){director.cancel(this)},set_dist:function(d){this.color="#f00"},enable:function(){this.color="#0f0"},render:function(sheet){var ctx=sheet.actor_context(0);var pos=this.pos,angle=this.angle;ctx.save();ctx.strokeStyle=this.color;
ctx.lineWidth=cfg.cursor.rad*6/35;ctx.lineCap="butt";ctx.beginPath();ctx.arc(pos.x,pos.y,cfg.cursor.rad,angle*Math.PI,(angle+.6)*Math.PI);ctx.stroke();ctx.beginPath();ctx.arc(pos.x,pos.y,cfg.cursor.rad,(.666+angle)*Math.PI,(.666+angle+.6)*Math.PI);ctx.stroke();ctx.beginPath();ctx.arc(pos.x,pos.y,cfg.cursor.rad,(1.333+angle)*Math.PI,(1.333+angle+.6)*Math.PI);ctx.stroke();ctx.restore()}};return m}
function GFX_SCENE(anim){var director=anim.Director;var rqueue=anim.Queue;var UNLINKED_COLOR="#ddd";var SLOW_UCOLOR="#aaa";var APPEAR_COLOR="#f00";var STROKE="#444";var _st_colors=["#8c564b","#ff7f0e","#d62728","#2ca02c","#1f77b4","#9467bd"];function _st_color(subtour){return _st_colors[subtour%_st_colors.length]}function Location(x,y,is_depot,max_vehicles){this.x=x;this.y=y;this.is_depot=is_depot;this.max_conn=is_depot?max_vehicles*2:2;this.render=function(){};this._subtour=-1;this._edges=0}Location.prototype=
{subtour:function(st,delay){if(st!=this._subtour){this._subtour=st;this.subtourAnim(st,delay)}},_is_endpoint:function(){return this._edges>0&&this._edges<this.max_conn},set_max_conn:function(x){this.max_conn=x;rqueue.add(this)},edge_count:function(count){if(count==this._edges)return;this._edges=count;if(count==0){this.unlinkAnim();this._subtour=-1}else if(count>=this.max_conn)this.connectAnim();else rqueue.add(this)},toString:function(){return"["+this.x.toFixed(1)+","+this.y.toFixed(1)+"/G]"},appear:function(callback){var _this=
this;this.render=this._render_anim;let color=VERY_SLOW?SLOW_UCOLOR:UNLINKED_COLOR;if(this.is_depot)color="#aaf";director.schedule(this,{radius$:[2,0,cfg.loc.rad_appear,.2,0,cfg.loc.rad,.3],color$:["#888",0,APPEAR_COLOR,.2,0,color,.3],offset$:[0,0,15,.2,0,2,.3]},function(){_this.render=_this._render_normal;if(callback)callback()});rqueue.add(this)},vanish:function(){var _this=this;director.cancel(this);this._anim_clear=true;this.render=this._render_anim;director.schedule(this,{radius:[0,2,.4],color:[0,
"#888",.4],offset:[0,0,.4]},function(){_this.render=function(sheet){_this._clear_loc(sheet);_this.render=function(){}}});rqueue.add(this)},unlinkAnim:function(){director.cancel(this,"color");this.render=this._render_normal;let color=VERY_SLOW?SLOW_UCOLOR:UNLINKED_COLOR;if(this.is_depot)color="#aaf";director.schedule(this,{color:[0,color,.6]});rqueue.add(this)},subtourAnim:function(subtour,delay){director.cancel(this,"color");this.render=this._render_normal;let color=this.is_depot?"#222":_st_color(subtour);
director.schedule(this,{color:[0,color,.5]});if(!this.connecting)director.schedule(this,{radius:[delay,cfg.loc.rad_subtour,.1,0,cfg.loc.rad,.2]});rqueue.add(this)},connectAnim:function(){director.cancel(this,"radius");this.render=this._render_normal;var _this=this;this.connecting=1;director.schedule(this,{radius:[0,cfg.loc.rad_connect,.2,0,cfg.loc.rad,.5]},function(){delete _this.connecting});rqueue.add(this)},close:function(){this.render=function(){}},refresh:function(){rqueue.add(this)},_clear_loc:function(sheet){var x=
Math.floor(this.x),y=Math.floor(this.y),r=Math.ceil(cfg.loc.rad+1);sheet.location_context().clearRect(x-r,y-r,2*r+1,2*r+1);if(this.is_depot)sheet.base_context().clearRect(x-r*1.5,y-r*1.5,3*r,3*r)},_render_depot:function(sheet){var ctx=sheet.base_context();ctx.save();ctx.beginPath();ctx.lineWidth=1;let w2=cfg.loc.rad*1.5;ctx.rect(this.x-w2,this.y-w2,w2*2,w2*2);ctx.fillStyle="#ddd";ctx.strokeStyle="#aaa";ctx.fill();ctx.stroke();ctx.restore()},_render_normal:function(sheet){this._clear_loc(sheet);var ctx=
sheet.location_context();if(this.radius>cfg.loc.rad)ctx=sheet.anim_context();if(this.is_depot)this._render_depot(sheet);ctx.save();ctx.beginPath();ctx.lineWidth=1;ctx.arc(this.x,this.y,this.radius,0,2*Math.PI);ctx.fillStyle=this.color;ctx.fill();if(STROKE&&!VERY_SLOW){ctx.strokeStyle=STROKE;ctx.stroke()}if(this._is_endpoint()){var r1=Math.floor(cfg.loc.rad/10*5);ctx.beginPath();ctx.rect(this.x-r1,this.y-r1,2*r1,2*r1);ctx.lineWidth=max(Math.floor(cfg.loc.rad/10*2),1);ctx.fillStyle="#fff";ctx.strokeStyle=
"#333";ctx.lineJoin="round";ctx.fill();ctx.stroke()}ctx.restore()},_render_anim:function(sheet){if(this._anim_clear)this._clear_loc(sheet);delete this._anim_clear;var ctx=sheet.anim_context();ctx.beginPath();ctx.arc(this.x,this.y,this.radius,0,2*Math.PI);ctx.fillStyle=this.color;ctx.lineWidth=1;ctx.fill();if(STROKE&&!VERY_SLOW){ctx.strokeStyle=STROKE;ctx.stroke()}}};function Scene(max_vehicles){this.max_vehicles=max_vehicles}Scene.prototype={_construct:function(vec){return new Location(vec.x,vec.y,
vec.is_depot,this.max_vehicles)},set_max_vehicles:function(x){this.max_vehicles=x},color:function(subtour){return _st_color(subtour)}};mixin(GraphicsFactory.prototype,Scene.prototype);return Scene}var E_COLOR="#ccc";var E_APPEAR_COLOR="#ff2";
function GFX_TOUR(anim){var rqueue=anim.Queue;var director=anim.Director;function Edge(v1,v2,intr){this.v1=v1;this.v2=v2;this.intr=intr;this._reset_state();rqueue.add(this);this._show_intr()}Edge.prototype={intersect:function(ix){if(!this.hidden)ix.show_edge();this.intr.push(ix)},intersects:function(){return this.intr},find_intersect:function(pt){var ix=this.intr;for(var i=0;i<ix.length;i++)if(ix[i].v===pt)return ix[i]},_show_intr:function(){var ix=this.intr;if(!ix)return;for(var i=0;i<ix.length;i++)if(ix[i].closed())ix.splice(i--,
1);else ix[i].show_edge()},_hide_intr:function(){var ix=this.intr;if(!ix)return;for(var i=0;i<ix.length;i++)if(ix[i].closed())ix.splice(i--,1);else ix[i].hide_edge()},show:function(){if(this.hidden){delete this.hidden;rqueue.add(this);this._show_intr()}},hide:function(){if(!this.hidden)this._hide_intr();this.hidden=true;rqueue.cancel(this);director.cancel(this);this._reset_state()},close:function(){this.hide();for(var i=0;i<this.intr.length;i++)this.intr[i].close();delete this.intr},_reset_state:function(){this.color=
E_COLOR;this.width=cfg.edge.width;delete this.animating;if(this.animation){director.cancel(this.animation);rqueue.cancel(this.animation);delete this.animation}},deleteAnim:function(){this.hide();var _this=this;this.animation=new EdgeDel(this.v1,this.v2,function(){delete _this.animation})},deleteMergeAnim:function(delay){this.hide();var _this=this;this.animation=new EdgeFade(this.v1,this.v2,delay,function(){_this.animation=new EdgeDel(_this.v1,_this.v2,function(){delete _this.animation})})},unlinkAnim:function(loc,
callback){if(VERY_SLOW){this.show();return}this.hide();var _this=this;this.animation=new EdgeUnlink(this,loc,function(){delete _this.animation;_this.show();if(callback)callback()})},refresh:function(){rqueue.add(this)},appear:function(){this.animating=true;var _this=this;director.schedule(this,{color$:[E_APPEAR_COLOR,0,E_COLOR,1.7],width$:[cfg.edge.flash_width,0,cfg.edge.width,1.5]},function(){delete _this.animating;rqueue.add(_this)});rqueue.add(this)},appearMerge:function(delay){this.animating=
true;var _this=this;director.schedule(this,{color$:["#aaa",delay,E_APPEAR_COLOR,.3,0,E_COLOR,1.7],width$:[cfg.edge.width,delay,cfg.edge.flash_width,.2,0,cfg.edge.width,1]},function(){delete _this.animating;rqueue.add(_this)});rqueue.add(this)},render_aggr:function(){return!this.animation&&!this.hidden&&!this.animating},render:function(sheet){if(this.hidden||this.animation)return;var ctx=this.animating?sheet.anim_tour_context():sheet.tour_context();var v1=this.v1,v2=this.v2;ctx.save();ctx.beginPath();
ctx.moveTo(v1.x,v1.y);ctx.lineTo(v2.x,v2.y);ctx.lineWidth=this.width+2;if(!VERY_SLOW){ctx.strokeStyle="#888";ctx.stroke();ctx.lineWidth=this.width}ctx.strokeStyle=this.color;ctx.stroke();ctx.restore()}};function EdgeDel(v1,v2,callback){var mid=v1.add(v2).mul(.5);this.norm=v2.sub(mid).norm();director.schedule(this,{v1$:[v1,0,mid,.17],v2$:[v2,0,mid,.17],width$:[0,0,.3,.17],color$:[E_COLOR,0,"#bbb",.2]},callback);rqueue.add(this)}EdgeDel.prototype={render:function(sheet){var v1=this.v1,v2=this.v2,mid=
v1.add(v2).mul(.5);var v1m=v1.add(mid).mul(.5);var v2m=v2.add(mid).mul(.5);var v1t=v1m.add(this.norm.mul(this.width));var v2t=v2m.add(this.norm.mul(-this.width));var ctx=sheet.anim_tour_context();ctx.beginPath();ctx.moveTo(v1.x,v1.y);if(!VERY_SLOW){ctx.quadraticCurveTo(v1t.x,v1t.y,mid.x,mid.y);ctx.moveTo(mid.x,mid.y);ctx.quadraticCurveTo(v2t.x,v2t.y,v2.x,v2.y)}else ctx.lineTo(v2.x,v2.y);ctx.lineWidth=cfg.edge.width+2;ctx.strokeStyle=this.color;ctx.stroke()}};function EdgeFade(v1,v2,delay,callback){this.v1=
v1;this.v2=v2;director.schedule(this,{color$:[E_COLOR,delay,"#eee",.5],scolor$:["#888",delay,"#eee",.5]},callback);rqueue.add(this)}EdgeFade.prototype={render:function(sheet){var ctx=sheet.anim_tour_context();var v1=this.v1,v2=this.v2;ctx.save();ctx.beginPath();ctx.moveTo(v1.x,v1.y);ctx.lineTo(v2.x,v2.y);ctx.lineWidth=cfg.edge.width+2;if(!VERY_SLOW){ctx.strokeStyle=this.scolor;ctx.stroke();ctx.lineWidth=cfg.edge.width}ctx.strokeStyle=this.color;ctx.stroke();ctx.restore()}};function EdgeUnlink(edge,
loc,callback){var v1=edge.v1;var v3=edge.v2;var v2=loc;this.v1=v1;this.v3=v3;this.v2=v2;var v2_t=v1.add(v3).mul(.5);var over=v2_t.sub(v2).mul(.2);var v2_o=v2_t.add(over);director.schedule(this,{v2:[0,v2_o,.1,0,v2_t,.05]},callback);rqueue.add(this)}EdgeUnlink.prototype={render:function(sheet){var ctx=sheet.anim_tour_context();var v1=this.v1,v2=this.v2,v3=this.v3;ctx.save();ctx.beginPath();ctx.moveTo(v1.x,v1.y);ctx.lineTo(v2.x,v2.y);ctx.lineTo(v3.x,v3.y);ctx.lineWidth=cfg.edge.width+2;ctx.strokeStyle=
"#888";ctx.lineJoin="round";ctx.stroke();ctx.lineWidth=cfg.edge.width;ctx.strokeStyle=E_COLOR;ctx.stroke();ctx.restore()}};function InterPt(v){this.v=v;this._vis_edges=0}InterPt.prototype={render_aggr:function(){return this.visible()},visible:function(){return this._vis_edges==2},show_edge:function(){this._vis_edges++;if(this.visible())rqueue.add(this)},hide_edge:function(){this._vis_edges--},close:function(){this._vis_edges=-1},closed:function(){return this._vis_edges==-1},render:function(sheet){if(!this.visible())return;
var ctx=sheet.inter_context();ctx.beginPath();ctx.strokeStyle="#d00";ctx.lineWidth=cfg.loc.rad*3/10;var w=cfg.loc.rad*.9;ctx.rect(this.v.x-w/2,this.v.y-w/2,w,w);ctx.stroke()}};function Tour(){}Tour.prototype={_construct:function(v1,v2,intr){return new Edge(v1,v2,intr)},render:function(sheet){var ctx=sheet.tour_context(1);ctx.beginPath();var it=this.items();for(var k in it){var e=it[k];if(e.render_aggr()){ctx.moveTo(e.v1.x,e.v1.y);ctx.lineTo(e.v2.x,e.v2.y);delete e.dirty}}ctx.lineWidth=cfg.edge.width+
2;if(!VERY_SLOW){ctx.strokeStyle="#888";ctx.stroke();ctx.lineWidth=cfg.edge.width}ctx.strokeStyle=this.edge_color?this.edge_color:E_COLOR;ctx.stroke()}};mixin(GraphicsFactory.prototype,Tour.prototype);function Intersects(){}Intersects.prototype={_construct:function(v){return new InterPt(v)},remove_all:function(gedge){var ix=gedge.intersects();for(var i=0;i<ix.length;i++)this.remove(ix[i])},render:function(sheet){var ctx=sheet.inter_context(1);if(!this.size())return;ctx.beginPath();ctx.strokeStyle=
"#d00";ctx.lineWidth=cfg.loc.rad*3/10;var w=cfg.loc.rad;var it=this.items();for(var k in it){var intr=it[k];if(intr.render_aggr())ctx.rect(intr.v.x-w/2,intr.v.y-w/2,w,w)}ctx.stroke()}};mixin(GraphicsFactory.prototype,Intersects.prototype);return{Tour:Tour,Intersects:Intersects}}
function GFX_ANIM(anim){var director=anim.Director;var rqueue=anim.Queue;function Decross(e1,e2,callback){this.p1=e1.v1;this.p2=e2.v1;this.v1=e2.v2;this.v2=e1.v2;e1.hide();e2.hide();director.schedule(this,{v1:[0,e1.v2,.2],v2:[0,e2.v2,.2]},function(){e1.show();e2.show();if(callback)callback()});rqueue.add(this)}Decross.prototype={render:function(sheet){var ctx=sheet.anim_tour_context();ctx.save();ctx.beginPath();ctx.moveTo(this.p1.x,this.p1.y);ctx.lineTo(this.v1.x,this.v1.y);ctx.moveTo(this.p2.x,this.p2.y);
ctx.lineTo(this.v2.x,this.v2.y);ctx.lineWidth=cfg.edge.width+2;if(!VERY_SLOW){ctx.strokeStyle="#888";ctx.lineCap="round";ctx.stroke();ctx.lineWidth=cfg.edge.width}ctx.strokeStyle=E_COLOR;ctx.stroke();ctx.beginPath();ctx.lineWidth=2;ctx.strokeStyle="#a88";ctx.moveTo(this.v1.x,this.v1.y);ctx.lineTo(this.v2.x,this.v2.y);ctx.stroke();if(!VERY_SLOW){ctx.fillStyle="#f00";ctx.moveTo(this.v1.x,this.v1.y);ctx.arc(this.v1.x,this.v1.y,6,0,2*Math.PI);ctx.moveTo(this.v2.x,this.v2.y);ctx.arc(this.v2.x,this.v2.y,
6,0,2*Math.PI);ctx.fill()}ctx.restore()}};function MissionAccomplished(msg){this.msg=msg;director.schedule(this,{size$:[1,0,2,2],color$:["#f00",1,"#eee",1],shadow$:["#444",0,"#eee",2],s_offset$:[8,0,20,2]});rqueue.add(this)}MissionAccomplished.prototype={render:function(sheet){var ctx=sheet.anim_context();ctx.save();ctx.shadowColor=this.shadow;ctx.shadowOffsetX=this.s_offset;ctx.shadowOffsetY=this.s_offset;ctx.fillStyle=this.color;ctx.textAlign="center";var sz=this.size*sheet.width*.05;ctx.font="bold "+
sz+"px sans-serif";ctx.fillText(this.msg,sheet.width/2,sheet.height/2);ctx.restore()}};function Diff(diff,pos){this.pos=pos;this.color=diff>0?"#f00":"#0f0";this.value=diff<0?diff:"+"+diff;this.off_x=0;this.off_y=-50;this.s_alpha=1;director.schedule(this,{color:[1,"#fff",1],off_y:[0,-150,2],s_offset:[0,20,2],s_alpha:[0,0,2]});rqueue.add(this,4)}function limit_pos(p,sheet){var x=p.x,y=p.y,change=0;if(y<160){y=160;change++}if(x<70){x=70;change++}if(x>sheet.width-70){x=sheet.width-70;change++}if(change)return vec(x,
y);return p}Diff.prototype={render:function(sheet){this.pos=limit_pos(this.pos,sheet);var pos=this.pos;var ctx=sheet.anim_context();ctx.save();ctx.shadowColor="rgba(60,60,60,"+this.s_alpha+")";ctx.shadowOffsetX=this.s_offset;ctx.shadowOffsetY=this.s_offset;ctx.fillStyle=this.color;ctx.textAlign="center";ctx.font="bold "+cfg.font.size+"px sans-serif";ctx.fillText(this.value,this.pos.x+this.off_x,this.pos.y+this.off_y);ctx.restore()}};return{Decross:Decross,Diff:Diff,MissionAccomplished:MissionAccomplished}}
function GraphicsFactory(){}
GraphicsFactory.prototype={_items:undefined,_factory_seq:1,_target_size:0,target_size:function(size){this._target_size=size},create:function(p1,p2,p3){var item=this._construct(p1,p2,p3);item._factory_key=this._factory_seq++;if(!this._items)this._items={};this._items[item._factory_key]=item;return item},remove:function(l){delete this._items[l._factory_key]},discard:function(){if(!this._items)return;for(var k in this._items)this._items[k].close();this._items={}},close:function(){this.discard()},size:function(){return this._items?
Object.keys(this._items).length:0},items:function(){return this._items?this._items:Object.freeze({})},render:function(sheet){if(!this._items)return;for(var k in this._items)this._items[k].render(sheet)}};function GFX(anim){var tour=GFX_TOUR(anim);return{cursor:GFX_CURSOR(anim),anim:GFX_ANIM(anim),Scene:GFX_SCENE(anim),Tour:tour.Tour,Intersects:tour.Intersects}}var BROKEN_CANVAS=false;
(function(){var ua=window.navigator.userAgent;if(ua.match(/android\s+4\.[1234]/i)&&!ua.match(/chrome/i))BROKEN_CANVAS=true})();function android_clear_workaround(canvas){canvas.style.display="none";var dummy=canvas.offsetHeight;canvas.style.display="block"}
function Sheet(id){this.node=$(id);this.layers={};this.contexts={};function append_canvas(node,w,h){var c=document.createElement("canvas");c.width=w;c.height=h;c.className="c_layer";node.appendChild(c);return c}var w=this.node.clientWidth;var h=this.node.clientHeight;this.layers["c_base"]=append_canvas(this.node,w,h);this.layers["c_tour"]=append_canvas(this.node,w,h);this.layers["c_anim_tour"]=append_canvas(this.node,w,h);this.layers["c_locations"]=append_canvas(this.node,w,h);this.layers["c_inter"]=
append_canvas(this.node,w,h);this.layers["c_anim"]=append_canvas(this.node,w,h);this.canvas_node=function(name){return this.layers[name]};for(var k in this.layers)this.contexts[k]=this.layers[k].getContext("2d");this.top_canvas=this.layers["c_anim"];this.width=w;this.height=h;this.base_context=function(clear){return this._clear_and_return("c_base",clear)};this.anim_context=function(clear){return this._clear_and_return("c_anim",clear)};this.anim_tour_context=function(clear){return this._clear_and_return("c_anim_tour",
clear)};this.location_context=function(clear){return this._clear_and_return("c_locations",clear)};this.inter_context=function(clear){return this._clear_and_return("c_inter",clear)};this.tour_context=function(clear){return this._clear_and_return("c_tour",clear)};this.actor_context=function(clear){return this._clear_and_return("c_anim",clear)};this._cleared={};this._clear_and_return=function(name,clr){var ctx=this.contexts[name];if(clr)if(clr==2||!this._cleared[name]){ctx.clearRect(0,0,this.width,this.height);
if(BROKEN_CANVAS)android_clear_workaround(this.layers[name]);this._cleared[name]=1}return ctx};this.node_position=nodeOffset(this.node);this.resize=function(){var w=this.node.clientWidth;var h=this.node.clientHeight;this.width=w;this.height=h;for(var k in this.layers){this.layers[k].width=w;this.layers[k].height=h}this.node_position=nodeOffset(this.node)};this.scroll=function(){this.node_position=nodeOffset(this.node)};this.ptr_event=function(ev){if(!ev){delete this.ptr_vector;return}var np=this.node_position;
this.ptr_vector=vec(ev.clientX-np.left,ev.clientY-np.top);return this.ptr_vector};this.pointer=function(){return this.ptr_vector};this.frame_start=function(){this.contexts["c_anim"].clearRect(0,0,this.width,this.height);this.contexts["c_anim_tour"].clearRect(0,0,this.width,this.height);if(BROKEN_CANVAS){android_clear_workaround(this.layers["c_anim"]);android_clear_workaround(this.layers["c_anim_tour"])}this._cleared={}};this.wipe_clean=function(){for(var k in this.contexts){this.contexts[k].clearRect(0,
0,this.width,this.height);if(BROKEN_CANVAS)android_clear_workaround(this.layers[k])}};this.tmpSheet=function(){var canv=document.createElement("canvas");canv.width=this.width;canv.height=this.height;canv.className="c_layer";return new TmpSheet(canv,this.width,this.height)}}
function TmpSheet(canvas,width,height){this.canvas=canvas;this.width=width;this.height=height;this._context=canvas.getContext("2d");this.get_canvas=function(){return this.canvas};this.anim_context=function(clear){return this._clear_and_return(clear)};this.location_context=function(clear){return this._clear_and_return(clear)};this.shadow_context=function(clear){return this._clear_and_return(clear)};this.tour_context=function(clear){return this._clear_and_return(clear)};this.actor_context=function(clear){return this._clear_and_return(clear)};
this._clear_and_return=function(name,clr){if(clr)if(clr==2||!this._cleared[name]){this._context.clearRect(0,0,this.width,this.height);if(BROKEN_CANVAS)android_clear_workaround(this.canvas);this._cleared=1}return this._context};this.frame_start=function(){delete this._cleared};this.wipe_clean=function(){this._context.clearRect(0,0,this.width,this.height);if(BROKEN_CANVAS)android_clear_workaround(this.canvas)}}var _l_id_seq=0;function _location_id_seq(){return"_"+_l_id_seq++}
function SceneLoc(x,y){this.x=x;this.y=y;this.id=_location_id_seq()}SceneLoc.prototype={toString:function(){return"["+this.id+":"+this.x.toFixed(3)+","+this.y.toFixed(3)+"]"}};mixin(geom.Vector.prototype,SceneLoc.prototype);function Scene(width,height){this.width=width;this.height=height;this.locs=[];this.index=new geom.GridIndex(width,height,10);this.events=new EventQueue;this.max_vehicles=2;this.depot_count=0}
function find_place(v,locs,mindist,width,height){var sqmin=mindist*mindist;var tv=v;for(var t=0;t<15;t++){var invalid;if(locs)for(var i=0;i<locs.length;i++)if(locs[i].sq_dist(tv)<sqmin){invalid=1;break}if(tv.x<cfg.scene.margin||tv.x>width-cfg.scene.margin)invalid=1;if(tv.y<cfg.scene.margin||tv.y>height-cfg.scene.margin)invalid=1;if(!invalid)return new SceneLoc(tv.x,tv.y);var dx=Math.random()*mindist*2-mindist;var dy=Math.random()*mindist*2-mindist;tv=vec(v.x+dx,v.y+dy)}}
Scene.prototype={resize:function(width,height){for(var i=0;i<this.locs.length;i++){var l=this.locs[i];if(l.x>width-cfg.scene.margin||l.y>height-cfg.scene.margin)this.remove(i--)}this.width=width;this.height=height;this.events.notify("resize",{width:this.width,height:this.height});this.index.resize(width,height);var tries=0;while(tries<10&&this.locs.length<3){this.add_random();tries++}if(tries==10){alert("Drawing area is too small - giving up!");throw"Drawing area is too small - giving up!";}},lookup:function(id){for(var i=
0;i<this.locs.length;i++)if(this.locs[i].id===id)return this.locs[i]},clear:function(){this.locs=[];this.index.discard();this.events.notify("discard")},load:function(points){var min_x=MAXVAL,max_x=-MAXVAL,min_y=MAXVAL,max_y=-MAXVAL;for(var i=0;i<points.length;i++){var p=points[i];if(p[0]<min_x)min_x=p[0];if(p[0]>max_x)max_x=p[0];if(p[1]<min_y)min_y=p[1];if(p[1]>max_y)max_y=p[1]}var xfact=(this.width-2*cfg.scene.margin)/(max_x-min_x);var yfact=(this.height-2*cfg.scene.margin)/(max_y-min_y);var fact;
var offs_x,offs_y;if(xfact<yfact){fact=xfact*.95;offs_x=Math.floor((this.width-(max_x-min_x)*fact)/2);offs_y=Math.floor((this.height-(max_y-min_y)*fact)/2)}else{fact=yfact*.95;offs_y=Math.floor((this.height-(max_y-min_y)*fact)/2);offs_x=Math.floor((this.width-(max_x-min_x)*fact)/2)}for(var i=0;i<points.length;i++){var p=points[i];var v=vec((p[0]-min_x)*fact+offs_x,(p[1]-min_y)*fact+offs_y);var list=this.query_rect(rect_around(v,cfg.scene.mindist*2));var loc=find_place(v,list,cfg.scene.mindist,this.width,
this.height);if(!loc){this.locs=[];this.index.discard();this.events.discard_events();throw"cannot load scene: area is too small";}this._add_location(loc)}this.events.fire_events()},_add_location:function(loc,notify){this.locs.push(loc);this.index.insert(loc);if(notify)this.events.notify("add",{location:loc});else this.events.create("add",{location:loc})},add:function(x,y,depot){var v=vec(x,y);var list=this.query_rect(rect_around(v,cfg.scene.mindist*2));var p=find_place(v,list,cfg.scene.mindist,this.width,
this.height);if(!p)throw"cannot place a new location at ("+x+","+y+")";if(depot)p.is_depot=true;this._add_location(p,"notify")},add_random:function(){for(var i=0;i<50;i++){var x=Math.random()*(this.width-cfg.scene.margin*2)+cfg.scene.margin;var y=Math.random()*(this.height-cfg.scene.margin*2)+cfg.scene.margin;var v=vec(x,y);var list=this.query_rect(rect_around(v,4*cfg.scene.mindist));var p=find_place(v,list,cfg.scene.mindist,this.width,this.height);if(p){this._add_location(p,"notify");return p}}this.events.notify("scene_full",
{})},add_depot:function(x,y){this.depot_count++;this.add(x,y,"depot")},init_depot:function(){this.remove_depots();this.add_depot(this.width/2,this.height/2)},remove_depots:function(){var depots=[];for(var i=0;i<this.locs.length;i++)if(this.locs[i].is_depot)depots.push(this.locs[i]);for(var i=0;i<depots.length;i++)this.remove_loc(depots[i]);this.depot_count=0},set_max_vehicles:function(x){if(this.max_vehicles==x)return;this.max_vehicles=x;this.events.create("max_vehicles",{value:x});this.events.fire_events()},
remove:function(idx){this.index.remove(this.locs[idx]);var l=this.locs.splice(idx,1)[0];this.events.notify("remove",{location:l});return l},remove_loc:function(loc){for(var i=0;i<this.locs.length;i++)if(loc===this.locs[i]){this.remove(i);return}},size:function(){return this.locs.length-this.depot_count},query_rect:function(r){return this.index.query_rect(r)},nearest_rad:function(v,rad){var cands=this.index.query_rect(rect_around(v,2.5*rad));if(!cands)return;var sq_d=rad*rad;var res;for(var i=0;i<
cands.length;i++){var pd=cands[i].sq_dist(v);if(pd<sq_d){sq_d=pd;res=cands[i]}}return res},nearest_dist:function(v){var L=max(this.width,this.height);var step=L/15,rad=step,cands;while(rad<=L+1E-4){cands=this.index.query_rect(rect_around(v,rad));if(cands.length>1)break;rad+=step}var res,min=MAXVAL;for(var i=0;i<cands.length;i++){if(cands[i]===v)continue;var pd=cands[i].sq_dist(v);if(pd<min){min=pd;res=cands[i]}}return{loc:res,dist:Math.sqrt(min)}}};function Edge(l1,l2){this.l1=l1;this.l2=l2}
Edge.prototype={other:function(l){if(this.l1==l)return this.l2;if(this.l2==l)return this.l1},adjacent:function(e){return this.l1==e.l1||this.l1==e.l2||this.l2==e.l2||this.l2==e.l1},overlap:function(e){if(this.l1===e.l1)return this.l1;if(this.l1===e.l2)return this.l1;if(this.l2===e.l1)return this.l2;if(this.l2===e.l2)return this.l2},intersect:function(e){var la1=this.l1,la2=this.l2,lb1=e.l1,lb2=e.l2;var dir_a=la2.sub(la1);var dir_b=lb2.sub(lb1);var dir_an=dir_a.norm();var alpha=dir_b.dot(dir_an);if(Math.abs(alpha)<
1E-7)return;var gamma=(la1.dot(dir_an)-lb1.dot(dir_an))/alpha;if(gamma>0&&gamma<1){var p1=lb1.add(dir_b.mul(gamma));var lambda;if(Math.abs(dir_a.x)>Math.abs(dir_a.y))lambda=(p1.x-la1.x)/dir_a.x;else lambda=(p1.y-la1.y)/dir_a.y;if(lambda>0&&lambda<1)return p1}},mid:function(){return this.l1.add(this.l2).div(2)},length:function(){return this.l1.dist(this.l2)},direction:function(){return this.l2.sub(this.l1)},toString:function(){return this.l1.toString()+":"+this.l2.toString()},contains:function(l){return this.l1==
l||this.l2==l},key:function(){if(this.l1.id<this.l2.id)return this.l1.id+"|"+this.l2.id;return this.l2.id+"|"+this.l1.id},equals:function(e){if(e.l1==this.l1)return e.l2==this.l2;else return e.l1==this.l2&&e.l2==this.l1}};function Intersects(index){this.inter=[];this.edge_index=index}
Intersects.prototype={resize:function(w,h){},add_edge:function(e){var inter_e=this.edge_index.query_edge(e);if(inter_e)for(var i=0;i<inter_e.length;i++){if(inter_e[i]==e)continue;if(inter_e[i].adjacent(e))continue;var ip=inter_e[i].intersect(e);if(ip)this.inter.push({point:ip,e1:inter_e[i],e2:e,other:function(e){return e===this.e1?this.e2:this.e1}})}},rem_edge:function(e){for(var i=0;i<this.inter.length;i++){var inter=this.inter[i];if(inter.e1==e||inter.e2==e)this.inter.splice(i--,1)}},getall:function(e){var res=
[];for(var i=0;i<this.inter.length;i++){var inter=this.inter[i];if(inter.e1==e||inter.e2==e)res.push(inter)}return res},discard:function(){for(var i=0;i<this.inter.length;i++){delete this.inter[i].e1;delete this.inter[i].e2}this.inter=[]},close:function(){this.discard();this.inter=undefined;this.edge_index=undefined}};function Subtours(tour){this.loc_subtour={};this.events=tour.events;this.tour=tour;this.subtour_seq=1}
Subtours.prototype={copy:function(ntour){var ns=new Subtours(ntour);ns.subtour_seq=this.subtour_seq;for(var lid in this.loc_subtour)ns.loc_subtour[lid]=this.loc_subtour[lid];return ns},close:function(){delete this.loc_subtour;delete this.events;delete this.tour},tour_id:function(l){return this._subt(l)},spread_and_test:function(l0,ltest){var orig=this.loc_subtour[ltest.id];this.loc_subtour[ltest.id]=-1;var st1=this.loc_subtour[l0.id];var _this=this;this.tour.visit_connected(l0,function(l){if(_this.loc_subtour[l.id]===
-1)_this.loc_subtour[l.id]=orig;if(_this.loc_subtour[l.id]!=st1){_this.loc_subtour[l.id]=st1;_this.events.create("subtour",{location:l,subtour:st1})}});if(this.loc_subtour[ltest.id]===-1){this.loc_subtour[ltest.id]=orig;return false}return true},_find_major:function(l){var _this=this;let ct={};var st0=this._subt(l);if(st0)ct[st0]=1;this.tour.visit_connected(l,function(l){var st=_this._subt(l);if(st)ct[st]=ct[st]?ct[st]+1:1});var res;let max=-1;for(let k in ct)if(ct[k]>max){max=ct[k];res=k}return res},
_change_subtour:function(l,st){if(this._subt(l)!=st){this.loc_subtour[l.id]=st;this.events.create("subtour",{location:l,subtour:st})}},recalc:function(seed){let locs=[];for(let i=0;i<seed.length;i++)if(seed[i].is_depot)locs=locs.concat(this.tour.neighbours(seed[i]));else locs.push(seed[i]);let visited={};var _this=this;let used_ids={};for(let i=0;i<locs.length;i++)if(!visited[locs[i].id]){var st=this._find_major(locs[i]);if(st){if(used_ids[st])st=this.subtour_seq++;used_ids[st]=1;this._change_subtour(locs[i],
st);this.tour.visit_connected(locs[i],function(l){_this._change_subtour(l,st);visited[l.id]=true})}visited[locs[i].id]=true}},spread:function(l0){var st2=this._subt(l0);var _this=this;this.tour.visit_connected(l0,function(l){if(_this._subt(l)!=st2){_this.loc_subtour[l.id]=st2;_this.events.create("subtour",{location:l,subtour:st2})}})},single_tour:function(locs){var sid=this._subt(locs[0]);for(var i=1;i<locs.length;i++)if(this._subt(locs[i])!==sid)return false;return true},report_subtours:function(locs){for(var i=
0;i<locs.length;i++){var stour=this._subt(locs[i]);if(stour)this.events.create("subtour",{location:locs[i],subtour:stour});else this.events.create("unlink",{location:locs[i]})}},same_tour:function(l1,l2){return this._subt(l1)===this._subt(l2)},has_tour:function(loc){return this._subt(loc)},discard:function(){this.loc_subtour={}},clear:function(scene){for(var lid in this.loc_subtour)this.events.create("unlink",{location:scene.lookup(lid)});this.discard()},remove:function(loc){delete this.loc_subtour[loc.id]},
join_tour:function(loc,list){var st=this._subt(loc);for(var i=0;i<list.length;i++){var x=this.loc_subtour[list[i].id];if(!x||x!=st){this.loc_subtour[list[i].id]=st;this.events.create("subtour",{location:list[i],subtour:st})}}},_subt:function(l){if(l.is_depot)return;return this.loc_subtour[l.id]},connect:function(l1,l2){var s1=this._subt(l1);var s2=this._subt(l2);if(!s1&&!s2){var ntour=this.subtour_seq++;this.loc_subtour[l1.id]=ntour;this.loc_subtour[l2.id]=ntour;this.events.create("subtour",{location:l1,
subtour:ntour});this.events.create("subtour",{location:l2,subtour:ntour})}else if(!s1){var st=this.loc_subtour[l2.id];this.loc_subtour[l1.id]=st;this.events.create("subtour",{location:l1,subtour:st})}else if(!s2){var st=this.loc_subtour[l1.id];this.loc_subtour[l2.id]=st;this.events.create("subtour",{location:l2,subtour:st})}else if(s1!=s2){var st=this.loc_subtour[l1.id];var _this=this;this.tour.visit_connected(l2,function(l){if(_this.loc_subtour[l.id]!=st){_this.loc_subtour[l.id]=st;_this.events.create("subtour",
{location:l,subtour:st})}})}},split:function(l1,l2){var unlinked=0;if(!this.tour.has_any_edges(l1)){this.remove(l1);unlinked++}if(!this.tour.has_any_edges(l2)){this.remove(l2);unlinked++}if(l1.is_depot||l2.is_depot)return;if(!unlinked){let visited={};this.tour.visit_connected(l1,function(l){visited[l.id]=1});if(!visited[l2.id]){var _this=this;var ntour=this.subtour_seq++;this.tour.visit_connected(l1,function(l){_this._change_subtour(l,ntour)})}}},major_subtour:function(){var lst=this.loc_subtour;
var st_map={};for(var lid in lst){var st=lst[lid];if(!st_map[st])st_map[st]=1;else++st_map[st]}var winner,max=0;for(var st in st_map)if(st_map[st]>max){max=st_map[st];winner=Number(st)}return winner},flip_replace:function(oldst,update){var lst=this.loc_subtour;for(var lid in lst)if(lst[lid]===oldst)lst[lid]=update;else if(lst[lid]===update)lst[lid]=oldst},merge:function(scene,other){var m_stid=this.major_subtour();var oldsts={};for(var lid in this.loc_subtour)oldsts[lid]=this.loc_subtour[lid];this.subtour_seq=
max(this.subtour_seq,other.subtour_seq);for(var lid in other.loc_subtour)this.loc_subtour[lid]=other.loc_subtour[lid];if(m_stid)this.flip_replace(this.major_subtour(),m_stid);for(var lid in this.loc_subtour)if(this.loc_subtour[lid]!==oldsts[lid])this.events.create("subtour",{location:scene.lookup(lid),subtour:this.loc_subtour[lid],context:"merge"})}};function LocStore(max_vehicles){this.loc_edges={};this.max_vehicles=max_vehicles}
LocStore.prototype={discard:function(){this.loc_edges={}},edges:function(l){var res=this.loc_edges[l.id];if(!res)return[];return res.slice()},edge_count:function(l){var e=this.loc_edges[l.id];if(!e)return 0;return e.length},neighbours:function(l){let e=this.loc_edges[l.id];var res=[];if(e)for(let i=0;i<e.length;i++)res.push(e[i].other(l));return res},other_edge:function(l,e){if(l.is_depot)return;var el=this.loc_edges[l.id];if(el[0]!==e)return el[0];if(el[1]!==e)return el[1]},edge_pair:function(l){if(l.is_depot)return;
var el=this.loc_edges[l.id];if(el&&el.length==2)return el.slice()},empty:function(l){var el=this.loc_edges[l.id];return!el||!el.length},_max:function(l){return l.is_depot?this.max_vehicles*2:2},set_max_vehicles:function(x){this.max_vehicles=x},can_connect:function(sub,l,count,lref){var el=this.loc_edges[l.id];if(!el)return true;let ct=0;if(l.is_depot&&lref){let stid=sub.tour_id(lref);if(stid)for(let i=0;i<el.length;i++){let t=sub.tour_id(el[ct].other(l));if(t==stid)ct++}}return ct+count<=2&&this._max(l)-
el.length>=count},reset_slots:function(){},_add_loc_edge:function(l,e){var el=this.loc_edges[l.id];if(!el)this.loc_edges[l.id]=[e];else el.push(e)},_rem_loc_edge:function(l,e){var el=this.loc_edges[l.id];for(var i=0;i<el.length;i++)if(el[i]==e)return el.splice(i,1)[0]},add_edge:function(e){this._add_loc_edge(e.l1,e);this._add_loc_edge(e.l2,e)},remove_edge:function(e){this._rem_loc_edge(e.l1,e);this._rem_loc_edge(e.l2,e)},dedup_edges:function(l){let e=this.edges(l);let res=[];for(var i=0;i<e.length;i++)for(var j=
i+1;j<e.length;j++)if(e[i].equals(e[j]))res.push(e.splice(j,1)[0]);for(var i=0;i<res.length;i++)this.remove_edge(res[i]);return res},tour_edge_data:function(sub,l){var el=this.loc_edges[l.id];if(!el||!el.length)return{};var tours={};var depot_e;for(var i=0;i<el.length;i++){let l0=el[i].other(l);if(l0.is_depot)depot_e=el[i];else{let tid=sub.tour_id(l0);var ll=tours[tid];if(!ll)tours[tid]=[el[i]];else ll.push(el[i])}}if(depot_e){for(let k in tours)tours[k].push(depot_e);tours["depot"]=depot_e}return tours},
select_removable:function(sub,l,lref,count){let tours=this.tour_edge_data(sub,l);let refid=lref?sub.tour_id(lref):0;if(refid){if(tours[refid]&&tours[refid].length+count>2)return tours[refid]}else refid=-1;for(let k in tours)if(k!=refid&&tours[k].length<2)return tours[k];for(let k in tours)if(tours[k].length==2)return tours[k];if(tours["depot"])return tours["depot"]}};
function Tour(scene){this.scene=scene;this.store=new LocStore(scene.max_vehicles);this._edges=[];this._edge_index=new geom.EdgeIndex(scene.width,scene.height,30);this._inter=new Intersects(this._edge_index);this.events=new EventQueue;this._subs=new Subtours(this);var _this=this;this.sc_handle=scene.events.register(function(evts){for(var i=0;i<evts.length;i++){var ev=evts[i];switch(ev.action){case "add":_this._add_handler(ev.location);break;case "remove":_this._rem_handler(ev.location);break;case "discard":_this._discard();
break;case "max_vehicles":_this._set_max_vehicles(ev.value);break;case "resize":_this._edge_index.resize(ev.width,ev.height);_this._inter.resize(ev.width,ev.height);break;case "scene_full":break;default:}}})}
Tour.prototype={copy:function(){var nt=new Tour(this.scene);var e=this._edges;var ne=nt._edges;for(var i=0;i<e.length;i++)nt._create_edge(e[i].l1,e[i].l2);nt._subs=this._subs.copy(nt);return nt},_set_max_vehicles:function(x){this.store.set_max_vehicles(x);this.adapt_max_vehicles(x);this._finish_action()},merge:function(other){var e=this._edges.slice();for(var i=0;i<e.length;i++)if(!other.find_edge(e[i].l1,e[i].l2))this._remove_edge(e[i],"merge");var oe=other._edges;for(var i=0;i<oe.length;i++)if(!this.find_edge(oe[i].l1,
oe[i].l2)){var ne=this._create_edge(oe[i].l1,oe[i].l2);this.events.create("connect",{edge:ne,context:"merge"})}this._subs.merge(this.scene,other._subs);this._finish_action()},_finish_action:function(){this.store.reset_slots();this.events.fire_events()},length:function(){var len=0;for(var i=0;i<this._edges.length;i++)len+=this._edges[i].length();return len},complete:function(){if(this._edges.length!=this.scene.size())return false;return this._subs.single_tour(this.scene.locs)},_visit_until:function(incoming_edge,
loc,last_loc,action){if(loc.is_depot)return 1;if(action)action(loc);if(last_loc&&loc==last_loc)return 1;var e=this.store.other_edge(loc,incoming_edge);if(!e)return 1;var next_loc=e.other(loc);return 1+this._visit_until(e,next_loc,last_loc,action)},visit_connected:function(loc,action){if(loc.is_depot)return 1;if(this.store.empty(loc)){action(loc);return 1}var u=this.store.edges(loc);if(u.length>=2){var mark={};var e=u[0];var r1=this._visit_until(e,loc,e.other(loc),function(l){mark[l.id]=1;if(action)action(l)});
if(!mark[e.other(loc).id])r1+=this._visit_until(e,e.other(loc),undefined,action);return r1}else return this._visit_until(undefined,loc,undefined,action)},report_subtours:function(){this._subs.report_subtours(this.scene.locs);this.events.fire_events()},_edge_sum:function(list){let sum=0;for(var i=0;i<list.length;i++)sum+=list[i].length();return sum},find_depot:function(){for(var i=0;i<this.scene.locs.length;i++)if(this.scene.locs[i].is_depot)return this.scene.locs[i]},tsp_stats:function(){var is_complete=
this.complete();var nodes=is_complete?this.scene.size():0;var length=this.length();return{length:length,nodes:nodes,valid:is_complete,subtours:[{nodes:nodes,length:length,subtour:1,is_complete:is_complete}]}},subtour_stats:function(){let depot=this.find_depot();if(!depot)return this.tsp_stats();var el=this.edges(depot);var mark={};var _this=this;var res=[];if(el)for(var i=0;i<el.length;i++){var start=el[i].other(depot);if(!mark[start.id]){mark[start.id]=1;let nodes=0;let edges={};let stid;this.visit_connected(start,
function(loc){nodes++;mark[loc.id]=1;stid=_this._subs.tour_id(loc);let el0=_this.edges(loc);for(var ei=0;ei<el0.length;ei++)edges[el0[ei].key()]=el0[ei]});let elist=object_values(edges);res.push({nodes:nodes,length:this._edge_sum(elist),subtour:stid,is_complete:elist.length==nodes+1})}}let nsum=0,lensum=0;for(var i=0;i<res.length;i++)if(res[i].is_complete){nsum+=res[i].nodes;lensum+=res[i].length}return{length:lensum,nodes:nsum,valid:nsum==this.scene.size(),subtours:res}},report_edges:function(){var e=
this._edges;for(var i=0;i<e.length;i++)this.events.create("add",{edge:e[i]});this.events.fire_events()},tour_locations:function(){var l=this.scene.locs;var res=[];var mark={};for(var i=0;i<l.length;i++){var lx=l[i];if(!mark[lx.id]&&!this.store.empty(lx))this.visit_connected(lx,function(loc){mark[loc.id]=1;res.push(loc)})}return res},is_connected:function(l1,l2){var dep=l1.is_depot?l1:l2;if(dep){var other=dep==l1?l2:l1;var el=this.store.edges(dep);if(!el)return false;for(let i=0;i<el.length;i++)if(this._subs.same_tour(el[i].other(dep),
other))return true}return this._subs.same_tour(l1,l2)},test_connected:function(l1,l2){var mark={};this.visit_connected(l1,function(l){mark[l.id]=1});return mark[l2.id]},intersects:function(e){if(e)return this._inter.getall(e);else return this._inter.inter},close:function(){this._discard();this.scene.events.unregister(this.sc_handle);this.events.close();this._inter.close();this._edge_index.close();this._subs.close();delete this._subs},_add_handler:function(l){},_rem_handler:function(l){this._unlink_all(l);
this.events.fire_events()},_discard:function(){this.store.discard();this._edges=[];this._edge_index.discard();this._inter.discard();this._subs.discard()},_rem_edge:function(e){this._inter.rem_edge(e);this._edge_index.remove(e);for(var i=0;i<this._edges.length;i++)if(this._edges[i]==e){this._edges.splice(i,1);return}},size:function(){return this._edges.length},query_rect:function(r){return this._edge_index.query_rect(r)},query_edge:function(e){return this._edge_index.query_edge(e)},_remove_edge:function(e,
context){this.store.remove_edge(e);this._rem_edge(e);this.events.create("remove",{edge:e,context:context})},remove_edge:function(e,context){this._remove_edge(e,context);this._subs.split(e.l1,e.l2);this._finish_action()},clear:function(){var e=this._edges.slice();for(var i=0;i<e.length;i++)this._remove_edge(e[i],"clear");this._subs.clear(this.scene);this._finish_action()},_create_edge:function(l1,l2){var e=new Edge(l1,l2);this._edges.push(e);this._edge_index.insert(e);this._inter.add_edge(e);this.store.add_edge(e);
return e},find_edge:function(l1,l2){var u=this.store.edges(l1);if(!u||!u.length)return;for(var i=0;i<u.length;i++)if(u[i].other(l1)===l2)return u[i]},edges:function(l){if(!l)return this._edges;return this.store.edges(l)},other_edge:function(l,e){return this.store.other_edge(l,e)},edge_pair:function(l){return this.store.edge_pair(l)},has_any_edges:function(l){return!this.store.empty(l)},can_connect:function(l,count){return this.store.can_connect(this._subs,l,count)},neighbours:function(l){return this.store.neighbours(l)},
dedup_edges:function(l){return this.store.dedup_edges(l)},connect:function(l1,l2,context){this.free_edges(l1,1);this.free_edges(l2,1,l1);var e=this._create_edge(l1,l2);this.events.create("connect",{edge:e,context:context});this._subs.connect(l1,l2);this._finish_action();return e},_regular_loc:function(e){return e.l1.is_depot?e.l2:e.l1},rewire_fresh:function(e,list,context){let lref=this._regular_loc(e);this._remove_edge(e,context);var depot;var l0=[e.l1];for(var i=0;i<list.length;i++){if(list[i].is_depot)depot=
list[i];l0.push(list[i])}l0.push(e.l2);for(var i=0;i<l0.length-1;i++){var e1=this._create_edge(l0[i],l0[i+1]);this.events.create("connect",{edge:e1,context:context})}this._subs.join_tour(lref,l0);if(depot){var _this=this;this.store.dedup_edges(depot).forEach(function(e){_this.events.create("remove",{edge:e})});this._subs.recalc([depot])}this._finish_action()},rewire:function(e,l){let lref=this._regular_loc(e);this.free_edges(l,2,lref);this.store.remove_edge(e);this._rem_edge(e);this.events.create("remove",
{edge:e,context:"rewire"});var e1=this._create_edge(e.l1,l);var e2=this._create_edge(e.l2,l);this.events.create("add",{edge:e1});this.events.create("add",{edge:e2});this._subs.join_tour(lref,[l]);if(l.is_depot)this._subs.recalc([l]);this._finish_action();return[e1,e2]},decross:function(inter){var e1=inter.e1;var e2=inter.e2;var l1=e1.l1;var l2=e1.l2;var l3=e2.l1;var l4=e2.l2;var depot=l1.is_depot?l1:l2.is_depot?l2:l3.is_depot?l3:l4.is_depot?l4:0;this.events.create("remove",{edge:e1,context:"decross"});
this.events.create("remove",{edge:e2,context:"decross"});this.store.remove_edge(e1);this._rem_edge(e1);this.store.remove_edge(e2);this._rem_edge(e2);var d1=l1.sq_dist(l4)+l2.sq_dist(l3);var d2=l1.sq_dist(l3)+l2.sq_dist(l4);var ne1,ne2;if(d1<d2)if(!this.test_connected(e1.l1,e2.l2)&&!this.test_connected(e1.l2,e2.l1)){ne1=this._create_edge(e1.l1,e2.l2);ne2=this._create_edge(e2.l1,e1.l2)}else{ne1=this._create_edge(e1.l1,e2.l1);ne2=this._create_edge(e2.l2,e1.l2)}else if(!this.test_connected(e1.l1,e2.l1)&&
!this.test_connected(e1.l2,e2.l2)){ne1=this._create_edge(e1.l1,e2.l1);ne2=this._create_edge(e2.l2,e1.l2)}else{ne1=this._create_edge(e1.l1,e2.l2);ne2=this._create_edge(e2.l1,e1.l2)}this.events.create("decross",{edges:[ne1,ne2]});var _this=this;if(depot)this.dedup_edges(depot).forEach(function(e){_this.events.create("remove",{edge:e})});this._subs.recalc([ne1.l1,ne2.l1,ne1.l2,ne2.l2]);this._finish_action()},snap_back:function(l,e,context){var remain0=e[0].other(l);var remain1=e[1].other(l);this._remove_edge(e[0],
"unlink");this._remove_edge(e[1],"unlink");var res_edge;var dup=this.find_edge(remain0,remain1);if(dup){res_edge=dup;this.events.create("unlink",{edge:dup,location:l,context:context,keep:true})}else{res_edge=this._create_edge(remain0,remain1);this.events.create("unlink",{edge:res_edge,location:l,context:context})}return res_edge},pickup_pair:function(l,ep,context){var remain0=ep[0].other(l);var remain1=ep[1].other(l);this._remove_edge(ep[0],"unlink");this._remove_edge(ep[1],"unlink");this._subs.remove(l);
let res=this._create_edge(remain0,remain1);this.events.create("add",{edge:res,context:context,hidden:true});this._finish_action();return res},adapt_max_vehicles:function(max){for(var i=0;i<this.scene.locs.length;i++){var l=this.scene.locs[i];if(l.is_depot)while(this.store.edge_count(l)>max*2){var el=this.store.select_removable(this._subs,l,0,1);this._reduce_location_edges(l,el)}}},_reduce_location_edges:function(l,el,context){if(el.length==2){this.snap_back(l,el,context);this._subs.remove(l)}else{this._remove_edge(el[0]);
this._subs.split(el[0].l1,el[0].l2)}},free_edges:function(l,count,lref,context){if(!this.store.can_connect(this._subs,l,count,lref)){var el=this.store.select_removable(this._subs,l,lref,count);this._reduce_location_edges(l,el,context)}if(count==2);},_unlink_all:function(l,context){var ep;do{ep=this.store.edge_pair(l);if(ep)this.snap_back(l,ep,context)}while(ep);while(!this.store.empty(l))this._remove_edge(this.store.edges(l)[0]);this._subs.remove(l)}};
var GenericActor={_init:function(){this.state=undefined;this.events=new EventQueue},active:function(){return this.state!==undefined},change_state:function(state){if(this.state)this.state.close();this.state=state;this.events.create("change_state",{state:state.name});this.events.fire_events()},activate:function(pos){this.state=this._activation_state(pos);this.events.fire_events()},release:function(pos){this.state.release(pos);this.state.close();delete this.state;this.events.fire_events()},close:function(){if(this.state)this.state.close();
delete this.state},move:function(pos){var pstate=this.state;this.state=this.state.move(pos);if(pstate!==this.state){if(pstate)pstate.close();this.events.create("change_state",{state:this.state.name})}this.events.fire_events()},render:function(sheet){if(!this.state)sheet.actor_context(2)}};var MAXVAL=999999999;
function filter_edges(list,rem){if(!rem)return list;if(!list)return list;var res=[];for(var i=0;i<list.length;i++){var skip=0;for(var j=0;j<rem.length;j++)if(list[i]==rem[j]){skip++;break}if(!skip)res.push(list[i])}return res}function TourActor(scene,tour){this.scene=scene;this.tour=tour;this._init()}
TourActor.prototype={_activation_state:function(pos){var inter=this._test_intersection(pos);if(inter)return new ActorStateIntersect(this,pos,inter);var edge_info;var loc=this._test_location(pos);if(loc){edge_info=this._test_edge(pos,loc);if(!edge_info){var ep=this.tour.edge_pair(loc);if(ep)return new ActorStateBend(this,pos,loc,ep);else return new ActorStateConnect(this,pos,loc)}}edge_info=edge_info||this._test_edge(pos);if(edge_info)if(edge_info.area=="outer")return new ActorStateConnect(this,pos,
undefined,edge_info);else return new ActorStateDelete(this,pos,edge_info.edge);return new ActorStateGrab(this,pos)},grab:function(pos){var edge_info;var loc=this._test_location(pos);if(loc){edge_info=this._test_edge(pos,loc);if(!edge_info){var ep=this.tour.edge_pair(loc);if(ep)return new ActorStateBend(this,pos,loc,ep);else return new ActorStateConnect(this,pos,loc)}}edge_info=edge_info||this._test_edge(pos);if(edge_info)if(edge_info.area=="outer")return new ActorStateConnect(this,pos,undefined,edge_info);
else return new ActorStateBend(this,pos,undefined,[edge_info.edge])},_test_intersection:function(pos){var list=this.tour.intersects();if(!list)return;var sel={d:cfg.act.sq_intersect};for(var i=0;i<list.length;i++){var x=list[i];var d=pos.sq_dist(x.point);if(d<sel.d)sel={d:d,inter:x}}if(sel.inter)return sel.inter},_test_location:function(pos){return this.scene.nearest_rad(pos,cfg.act.location)},_test_edge:function(pos,loc){var rad,tabu_edges=[];if(loc){rad=cfg.act.edge_near_loc;var e=this.tour.edges(loc);
if(e)tabu_edges=e}else rad=cfg.act.edge;var edges=filter_edges(this.tour.query_rect(rect_around(pos,2.5*rad)),tabu_edges);if(!edges)return;var sel={d:MAXVAL};for(var i=0;i<edges.length;i++){var e=edges[i];if(!e.gfx||e.gfx.hidden)continue;var proj;if(pos.in_circle(e)&&(proj=pos.project(e))){var d=proj.sq_dist(pos);if(d<rad*rad&&d<sel.d){var locdist=min(proj.sq_dist(e.l1),proj.sq_dist(e.l2));sel={d:d,edge:e,proj:proj,area:e.length()<70?"inner":locdist>20*20?"inner":"outer"}}}}if(sel.edge){if(sel.area==
"outer")sel.start=sel.proj.lambda<.5?sel.edge.l1:sel.edge.l2;return sel}}};mixin(GenericActor,TourActor.prototype);function ActorStateGrab(actor,pos,inact_rad){this.name="GRAB";this.start_pos=pos;this.pos=pos;if(inact_rad)this.inact_sq=inact_rad*inact_rad;this.actor=actor;this.cursor=new gfx.cursor.Grab(pos)}
ActorStateGrab.prototype={close:function(){this.cursor.stop();delete this.cursor},move:function(pos){this.pos=pos;this.cursor.position(pos);if(this.inact_sq&&this.pos.sq_dist(this.start_pos)<this.inact_sq)return this;var st=this.actor.grab(pos);return st||this},release:function(pos){}};
function ActorStateBend(actor,pos,loc,edges){this.actor=actor;this.head=loc;this.pos=pos;this.name="BEND";if(loc&&edges){this.picked_up=true;this.edge=actor.tour.pickup_pair(loc,edges,"silent");actor.events.create("location_change",{location:loc})}else if(edges.length==2){this.edge=edges[0];this.fixed=edges[0].overlap(edges[1]);this.alternate=edges[1].other(this.fixed);actor.events.create("hide_edge",{edge:this.edge})}else{this.edge=edges[0];actor.events.create("hide_edge",{edge:this.edge})}this.cursor=
new gfx.cursor.Bend(this.edge.l1,this.edge.l2,this.pos);this._check_switch(pos)}
ActorStateBend.prototype={close:function(){this.cursor.stop();delete this.cursor},_connectable:function(pos){var tour=this.actor.tour;var loc=this.actor._test_location(pos);if(loc&&loc!==this.head){var l1=this.edge.l1,l2=this.edge.l2;if(loc==l1||loc==l2)return;if(tour.find_edge(l1,loc)&&tour.find_edge(l2,loc))return;return loc}},_check_switch:function(pos){if(!(this.alternate&&this.fixed))return;var v1=this.edge.other(this.fixed);var v2=this.alternate;var fix=this.fixed;var dir1=v1.sub(fix);dir1=
dir1.div(dir1.len());var dir2=v2.sub(fix);dir2=dir2.div(dir2.len());var d1=pos.dist(fix.add(dir1));var d2=pos.dist(fix.add(dir2));if(d2<d1){var other_edge=this.actor.tour.find_edge(this.alternate,this.fixed);this.alternate=this.edge.other(this.fixed);this.actor.events.create("hide_edge",{edge:other_edge});this.actor.events.create("show_edge",{edge:this.edge});this.edge=other_edge}this.cursor.flip(this.edge.l1,this.edge.l2,this.alternate)},_stabilize_prev:function(){if(this.alternate&&this.fixed){var e=
this.actor.tour.find_edge(this.alternate,this.fixed);if(e)this.actor.events.create("stable_edge",{edge:e})}},move:function(pos){var pstr=pos.toString();this.pos=pos;this.cursor.position(pos);this._check_switch(pos);var l=this._connectable(pos);if(l){var edges=this.actor.tour.rewire(this.edge,l);delete this.edge;this.actor.events.create("location_change",{location:l});this._stabilize_prev();return new ActorStateBend(this.actor,this.pos,undefined,edges)}return this},release:function(pos){if(pos&&this.head&&
this.head.dist(pos)<cfg.act.location){this.actor.tour.rewire(this.edge,this.head);this.actor.events.create("location_change",{location:this.head})}else{this.actor.events.create("release_bend",{pos:this.pos,edge:this.edge});this._stabilize_prev();let ev=this.actor.events;this.actor.tour.dedup_edges(this.edge.l1).forEach(function(e){ev.create("remove",{edge:e})})}}};
function ActorStateConnect(actor,pos,loc,edge_info){this.actor=actor;this.name="CONNECT";if(edge_info){this.actor.tour.remove_edge(edge_info.edge,"silent");this.start=edge_info.start}else this.start=loc;this.actor.events.create("location_change",{location:this.start,add_edges:1});this.pos=pos;this.cursor=new gfx.cursor.Connect(this.start,this.pos)}
ActorStateConnect.prototype={close:function(){this.cursor.stop();delete this.cursor},_test_overshoot:function(pos){var locs=this.actor.scene.query_rect(rect_around(pos,50));if(locs&&locs.length){var test_edge=new Edge(this.start,pos);for(var i=0;i<locs.length;i++){if(locs[i].dist(pos)>cfg.act.conn_over_d)continue;var p=locs[i].project(test_edge);if(p&&p.dist(locs[i])<cfg.act.conn_over_r)return locs[i]}}},move:function(pos){this.pos=pos;this.cursor.position(pos);var t=this.actor.tour;var l=this.actor._test_location(pos);
if(!l||l===this.start)l=this._test_overshoot(pos);if(l&&l!==this.start)if(!t.find_edge(this.start,l)){if(this.rm_edge){t.remove_edge(this.rm_edge);this.rm_edge=undefined;this.actor.events.create("location_change",{location:this.start})}var e=t.connect(this.start,l);this.actor.events.create("stable_edge",{edge:e});this.actor.events.create("location_change",{location:l,add_edges:1});this.rm_edge=t.other_edge(l,e);this.start=l;this.cursor.connect(this.start)}var my_e=new Edge(this.start,this.pos);var inter_e=
this.actor.tour.query_edge(my_e);var intersects=[];if(inter_e)for(var i=0;i<inter_e.length;i++){if(inter_e[i].l1===this.start||inter_e[i].l2===this.start)continue;var ip=inter_e[i].intersect(my_e);if(ip)intersects.push(ip)}this.cursor.intersects(intersects);return this},release:function(pos){this.actor.events.create("location_change",{location:this.start})}};
function ActorStateIntersect(actor,pos,inter){this.name="INTERSECT";this.actor=actor;this.inter=inter;this.act_pos=pos;this.pos=pos;var _this=this;this.change_timer=setTimeout(function(){_this.change()},500);this.cursor=new gfx.cursor.Intersect(pos)}
ActorStateIntersect.prototype={close:function(){this.cursor.stop();delete this.cursor},_newstate:function(){clearTimeout(this.change_timer);delete this.change_timer;var dir=this.pos.sub(this.inter.point);var alpha1=dir.project_angle(this.inter.e1.direction());var alpha2=dir.project_angle(this.inter.e2.direction());var edge=alpha1>alpha2?this.inter.e1:this.inter.e2;return new ActorStateBend(this.actor,this.pos,undefined,[edge])},change:function(){this.actor.change_state(this._newstate())},move:function(pos){this.pos=
pos;if(pos.sq_dist(this.act_pos)>cfg.act.sq_move_inact)return this._newstate();return this},release:function(pos){if(this.change_timer){clearTimeout(this.change_timer);delete this.change_timer}this.actor.tour.decross(this.inter)}};function ActorStateDelete(actor,pos,edge){this.name="DELETE";this.actor=actor;this.edge=edge;this.act_pos=pos;this.pos=pos;var _this=this;this.change_timer=setTimeout(function(){_this.change()},500);this.cursor=new gfx.cursor.Delete(pos)}
ActorStateDelete.prototype={close:function(){this.cursor.stop();delete this.cursor},_newstate:function(){clearTimeout(this.change_timer);delete this.change_timer;return new ActorStateBend(this.actor,this.pos,undefined,[this.edge])},change:function(){this.actor.change_state(this._newstate())},move:function(pos){this.pos=pos;if(pos.sq_dist(this.act_pos)>cfg.act.sq_move_inact)return this._newstate();return this},release:function(pos){if(this.change_timer){clearTimeout(this.change_timer);delete this.change_timer}this.actor.tour.remove_edge(this.edge)}};
var LOC_DEL_RAD=15;function SceneActor(scene,minlocs){this.scene=scene;this.minlocs=minlocs;this._init()}SceneActor.prototype={_activation_state:function(pos){var loc=this._test_location(pos);if(loc&&!loc.is_depot&&this.scene.size()>this.minlocs)return new ActorStateDeleteLoc(this,pos,loc);else return new ActorStateCreateLoc(this,pos)},_test_location:function(pos){return this.scene.nearest_rad(pos,LOC_DEL_RAD)}};mixin(GenericActor,SceneActor.prototype);
function ActorStateDeleteLoc(actor,pos,loc){this.name="DELETE_LOC";this.pos=pos;this.loc=loc;this.actor=actor;this.cursor=new gfx.cursor.Delete(pos)}ActorStateDeleteLoc.prototype={close:function(){this.cursor.stop();delete this.cursor},move:function(pos){this.pos=pos;this.cursor.position(pos);if(this.loc.sq_dist(pos)>LOC_DEL_RAD*LOC_DEL_RAD)return new ActorStateCreateLoc(this.actor,pos);return this},release:function(pos){this.actor.scene.remove_loc(this.loc);this.actor.events.notify("remove",{})}};
function ActorStateCreateLoc(actor,pos){this.name="CREATE_LOC";this.pos=pos;this.actor=actor;this.cursor=new gfx.cursor.Create(pos);this.move(pos)}
ActorStateCreateLoc.prototype={close:function(){this.cursor.stop();delete this.cursor},move:function(pos){this.pos=pos;this.cursor.position(pos);var lm=cfg.scene.margin;if(pos.x<lm||pos.x>this.actor.scene.width-lm||pos.y<lm||pos.y>this.actor.scene.height-lm){this.cursor.set_dist(1);return this}var loc=this.actor.scene.nearest_rad(pos,cfg.scene.mindist);if(loc)this.cursor.set_dist(loc.dist(pos)/cfg.scene.mindist);else this.cursor.enable();return this},release:function(pos){if(!pos)return;try{var loc=
this.actor.scene.nearest_rad(pos,cfg.scene.mindist);if(!loc){var sc=this.actor.scene;if(sc.size()>=MAX_LOCS){var idx=Math.floor(Math.random()*sc.size());sc.remove(idx)}sc.add(pos.x,pos.y);this.actor.events.notify("add",{})}}catch(x){}}};function DepotActor(scene,callback){this.scene=scene;this.callback=callback;this._init()}DepotActor.prototype={_activation_state:function(pos){return new ActorStateCreateDepot(this,pos)}};mixin(GenericActor,DepotActor.prototype);
function ActorStateCreateDepot(actor,pos){this.name="CREATE_DEPOT";this.pos=pos;this.actor=actor;this.cursor=new gfx.cursor.Create(pos);this.move(pos)}ActorStateCreateDepot.prototype={release:function(pos){if(!pos)return;try{var loc=this.actor.scene.nearest_rad(pos,cfg.scene.mindist);if(!loc){var sc=this.actor.scene;sc.remove_depots();sc.add_depot(pos.x,pos.y);this.actor.events.notify("add",{type:"depot"});setTimeout(this.actor.callback,0)}}catch(x){}}};mixin(ActorStateCreateLoc.prototype,ActorStateCreateDepot.prototype);
var MAX_VEHICLES=4;function VRPBoard(anim,color_func){this.director=anim.Director;this.rqueue=anim.Queue;this.color_func=color_func;this.n_length=$("t_length");this.n_stats=$("d_stats");this.n_valid=$("d_valid");this.n_valid_t=$("tx_valid");this.n_valid_s=$("tx_valid_s");this.current_length=0;this.score_color="#000";this.diff_color="#eee";this.num_vehicles=2;this.level=10;this.current_actor="tour";this.scale=1E3/3/max(screen.width,screen.height)}
VRPBoard.prototype={length:function(x){if(isAndroid()||VERY_SLOW)this.current_length=x;else{this.director.cancel(this,"current_length");this.director.schedule(this,{current_length:[0,x,1]})}this.rqueue.add(this)},set_level:function(x){this.level=x},set_stats:function(s){this.length(s.length);let html="<ul>";let ct=0;for(var i=0;i<s.subtours.length;i++)if(s.subtours[i].is_complete){ct++;let st=s.subtours[i];let prebox=st.subtour?'<div class="prebox" style="background-color: '+this.color_func(st.subtour)+
';"></div>':'<div class="prebox"></div>';html+="<li>"+prebox+Math.floor(st.length*this.scale+.5)+'<span class="node_count">('+st.nodes+" "+tr("Locations")+")</span></li>"}html+="</ul>";this.n_stats.innerHTML=ct?html:"";if(s.valid){this.n_valid.className="s_valid";this.n_valid_t.innerHTML=tr("Solution is valid");this.n_valid_s.innerHTML=tr("valid solution")}else{this.n_valid.className="s_incomplete";this.n_valid_t.innerHTML=tr("Solution is invalid");this.n_valid_s.innerHTML=tr("invalid solution")}},
add_vehicle:function(){if(this.num_vehicles>=MAX_VEHICLES)return MAX_VEHICLES;this.num_vehicles++;$("current_vehicles").innerHTML=this.num_vehicles;return this.num_vehicles},rem_vehicle:function(){if(this.num_vehicles<=1)return 1;this.num_vehicles--;$("current_vehicles").innerHTML=this.num_vehicles;return this.num_vehicles},cycle_vehicles:function(){if(this.num_vehicles==MAX_VEHICLES)this.num_vehicles=1;else this.num_vehicles++;$("current_vehicles").innerHTML=this.num_vehicles;return this.num_vehicles},
reset:function(x){this.director.cancel(this);this.n_length.innerHTML=x?Math.floor(x*this.scale):0;this.n_stats.innerHTML="";this.current_length=0;this.rqueue.add(this)},updateHtml:function(name,val){var prev=this["_prev_val_"+name];if(typeof prev==="undefined"||val!=prev){this[name].innerHTML=val;this["_prev_val_"+name]=val}},scale_diff:function(x,y){return Math.floor(x*this.scale)-Math.floor(y*this.scale)},render:function(dummy){this.updateHtml("n_length",Math.floor(this.current_length*this.scale+
.5))},switch_actor:function(){if(this.current_actor!="scene"){this.current_actor="scene";$("a_edit").className="edit_scene";$("a_depot").className="edit_none"}else{this.current_actor="tour";$("a_edit").className="edit_tour"}return this.current_actor},switch_depot:function(){if(this.current_actor!="depot"){$("a_depot").className="edit_scene";this.current_actor="depot";$("a_edit").className="edit_tour"}else{$("a_depot").className="edit_none";this.current_actor="tour"}return this.current_actor},set_depot:function(){$("a_depot").className=
"edit_none";this.current_actor="tour"},reset_actor:function(){this.current_actor="tour";$("a_edit").className="edit_tour";$("a_depot").className="edit_none";return"tour"},actor_type:function(){return this.current_actor}};var MSPointer;if(window.PointerEvent&&navigator.maxTouchPoints)MSPointer={down:"pointerdown",up:"pointerup",leave:"pointerleave",move:"pointermove"};else if(window.MSPointerEvent&&navigator.msMaxTouchPoints)MSPointer={down:"MSPointerDown",up:"MSPointerUp",leave:"MSPointerLeave",move:"MSPointerMove"};
document.addEventListener("touchmove",function(){});function touchMode(){return FORCE_TOUCHMODE||MSPointer||isMobile()}
function Controls(engine){var module={};function setupPage(ev){setTimeout(function(){if(isAndroid()&&!isChrome())$("layers").style.height=Math.floor(window.outerHeight/window.devicePixelRatio)+"px";else $("layers").style.height=Math.floor(window.outerHeight)+"px";setTimeout(function(){engine.resizeEvent()},1)},1)}module.init=function(sheet){if(isPhone()){bindEvent(window,"load",setupPage);bindEvent(window,"orientationchange",setupPage);bindEvent(window,"resize",setupPage)}else bindEvent(window,"resize",
engine.resizeEvent);if(!touchMode()){mouse_init(sheet);bindEvent(window,"scroll",function(){sheet.scroll()})}else{touch_init(sheet);bindEvent(document.body,"contextmenu",disableEvent);bindEvent(document.body,"MSHoldVisual",disableEvent)}};module.setup_button=function(node,h_down,h_up){var n=node;if(typeof n.style.msTouchAction!="undefined")n.style.msTouchAction="none";if(typeof n.style.touchAction!="undefined")n.style.touchAction="none";if(!touchMode())if(h_down&&h_up){bindEvent(n,"mousedown",function(ev){h_down()});
bindEvent(n,"mouseup",function(ev){h_up()});bindEvent(n,"mouseleave",function(ev){h_up()})}else bindEvent(n,"click",function(ev){h_down()});else if(MSPointer)if(h_down&&h_up){bindEvent(n,MSPointer.down,function(ev){_button_touch_start(n,ev,h_down)});bindEvent(n,MSPointer.up,function(ev){_button_touch_up(n,ev,h_up)});bindEvent(n,MSPointer.leave,function(ev){_button_touch_up(n,ev,h_up)})}else{bindEvent(n,MSPointer.down,function(ev){_button_touch_start(n,ev)});bindEvent(n,MSPointer.up,function(ev){_button_touch_end(n,
ev,h_down)});bindEvent(n,MSPointer.move,function(ev){_button_touch_move(n,ev)})}else if(h_down&&h_up){bindEvent(n,"touchstart",function(ev){_button_touch_start(n,ev,h_down)});bindEvent(n,"touchend",function(ev){_button_touch_up(n,ev,h_up)});bindEvent(n,"touchleave",function(ev){_button_touch_up(n,ev,h_up)});bindEvent(n,"touchcancel",function(ev){_button_touch_up(n,ev,h_up)})}else{bindEvent(n,"touchstart",function(ev){_button_touch_start(n,ev)});bindEvent(n,"touchend",function(ev){_button_touch_end(n,
ev,h_down)});bindEvent(n,"touchleave",function(ev){_button_touch_cancel(n,ev)});bindEvent(n,"touchcancel",function(ev){_button_touch_cancel(n,ev)});bindEvent(n,"touchmove",function(ev){_button_touch_move(n,ev)})}};var _current_touch;function update_touch(t){_current_touch={id:typeof t.pointerId!=="undefined"?t.pointerId:t.identifier,clientX:t.clientX,clientY:t.clientY}}function touch_by_id(id,t){if(!t)return;for(var i=0;i<t.length;i++)if(t[i].identifier===id)return t[i]}function identify_touch(ev,
active){var t=ev.changedTouches;if(t&&t.length){if(active)return touch_by_id(active.id,t);return t[0]}if(typeof ev.pointerId!=="undefined")if(active){if(active.id==ev.pointerId)return ev;return}else return ev}function _button_touch_start(n,ev,handler){stopDefaultAction(ev);if(!_current_touch){var touch=identify_touch(ev);if(!touch)return;n.style.backgroundColor="#ff0";update_touch(touch);if(handler)handler()}}function _button_touch_up(n,ev,handler){stopDefaultAction(ev);n.style.backgroundColor="#fff";
if(!_current_touch)return;var tx=identify_touch(ev,_current_touch);if(!tx)return;_current_touch=undefined;if(handler)handler()}function _button_touch_end(n,ev,handler){stopDefaultAction(ev);n.style.backgroundColor="#fff";if(!_current_touch)return;var tx=identify_touch(ev,_current_touch);if(!tx)return;var dx=tx.clientX-_current_touch.clientX,dy=tx.clientY-_current_touch.clientY,dist=Math.sqrt(dx*dx+dy*dy);_current_touch=undefined;if(dist<cfg.touch.maxdist)if(handler)handler()}function _button_touch_move(n,
ev){stopDefaultAction(ev);if(!_current_touch)return;var tx=identify_touch(ev,_current_touch);if(!tx)return;var dx=tx.clientX-_current_touch.clientX,dy=tx.clientY-_current_touch.clientY,dist=Math.sqrt(dx*dx+dy*dy);if(dist>cfg.touch.maxdist){_current_touch=undefined;n.style.backgroundColor="#fff"}}function _button_touch_cancel(n,ev,handler){stopDefaultAction(ev);n.style.backgroundColor="#fff";var tx=identify_touch(ev,_current_touch);if(!tx)return;_current_touch=undefined}function mouse_init(sheet){var canvas=
sheet.top_canvas;bindEvent(canvas,"mousemove",engine.moveSheet);bindEvent(canvas,"mouseleave",function(){engine.leaveSheet()});bindEvent(canvas,"mousedown",engine.touchSheet);bindEvent(canvas,"mouseup",engine.leaveSheet)}function touch_init(sheet){var canvas=sheet.top_canvas;if(MSPointer){bindEvent(canvas,MSPointer.down,_touchstartEvent);bindEvent(canvas,MSPointer.move,_touchmoveEvent);bindEvent(canvas,MSPointer.up,_touchendEvent);bindEvent(canvas,MSPointer.leave,_touchendEvent)}else{bindEvent(canvas,
"touchstart",_touchstartEvent);bindEvent(canvas,"touchmove",_touchmoveEvent);bindEvent(canvas,"touchleave",_touchendEvent);bindEvent(canvas,"touchcancel",_touchendEvent);bindEvent(canvas,"touchend",_touchendEvent)}}function _touchstartEvent(ev){stopDefaultAction(ev);if(!_current_touch){var touch=identify_touch(ev);if(!touch)return;update_touch(touch);engine.touchSheet(_current_touch)}else{var ut=identify_touch(ev,_current_touch);if(ut)update_touch(ut);engine.moveSheet(_current_touch)}}function _touchmoveEvent(ev){stopDefaultAction(ev);
if(!_current_touch)return;var ut=identify_touch(ev,_current_touch);if(ut)update_touch(ut);engine.moveSheet(_current_touch)}function _touchendEvent(ev){stopDefaultAction(ev);var ut=identify_touch(ev,_current_touch);if(ut)update_touch(ut);if(_current_touch.clientX&&_current_touch.clientY)engine.leaveSheet(_current_touch);else engine.leaveSheet();_current_touch=undefined}return module}
function TourEngine(sheet_param){var _sheet=sheet_param;var module={};var _scene,_tour;var _director,_rqueue;var _gtour,_gscene,_ginter;var _actor;function setup(){_scene=new Scene(_sheet.width,_sheet.height);_tour=new Tour(_scene);_director=anim.Director;_rqueue=anim.Queue;_gtour=new gfx.Tour;_gscene=new gfx.Scene(_scene.max_vehicles);_ginter=new gfx.Intersects;_actor=new TourActor(_scene,_tour);_tour.events.register(tour_event_listener);_actor.events.register(actor_event_listener);_scene.events.register(scene_event_listener)}
function test_autoconnect_loc(l){if(!_tour.can_connect(l,2))return;var edges=_tour.query_rect(rect_around(l,cfg.act.autoconn*2));if(edges){var min=MAXVAL,sel;for(var i=0;i<edges.length;i++){var e=edges[i],p=l.project(e),d=p?p.dist(l):MAXVAL;if(d<cfg.act.autoconn){sel=e;min=d}}if(sel)_tour.rewire_fresh(e,[l],"auto_loc")}}function test_autoconnect_sub(l1,l2,locs){var e=new Edge(l1,l2),found,min=cfg.act.autoconn;for(var i=0;i<locs.length;i++){var l=locs[i];if(l===l1||l===l2)continue;var p=l.project(e),
d=p?p.dist(l):MAXVAL;if(d<min){found=l;d=min}}if(found){var sublocs=[];if(locs.length>1){for(var i=0;i<locs.length;i++)if(locs[i]!==found)sublocs.push(locs[i]);var res1=test_autoconnect_sub(l1,found,sublocs);var res2=test_autoconnect_sub(found,l2,sublocs);for(var i=1;i<res2.length;i++)res1.push(res2[i]);return res1}else return[l1,found,l2]}else return[l1,l2]}function test_autoconnect(e){var m=e.mid(),rad=m.dist(e.l1);var locs=_scene.query_rect(rect_around(m,rad*2));if(!locs)return;var cands=[];var closest,
min=cfg.act.autoconn;for(var i=0;i<locs.length;i++){var l=locs[i];if(l===e.l1||l===e.l2)continue;if(_tour.can_connect(l,2))if(l.dist(m)<rad){var p=l.project(e),d=p?p.dist(l):MAXVAL;if(p)cands.push(l);if(d<min){closest=l;min=d}}}if(closest){var sublocs=[];if(cands.length>1){for(var i=0;i<cands.length;i++)if(cands[i]!==closest)sublocs.push(cands[i]);var res=test_autoconnect_sub(e.l1,closest,sublocs);var res2=test_autoconnect_sub(closest,e.l2,sublocs);for(var i=1;i<res2.length;i++)res.push(res2[i]);
res.shift();res.pop();_tour.rewire_fresh(e,res,"auto");for(var i=0;i<res.length;i++)locationState(res[i])}else _tour.rewire_fresh(e,[closest],"auto")}}function create_edge_graphics(e){var intr=_tour.intersects(e).map(function(x){var oe=x.other(e);if(oe.gfx){var ix=oe.gfx.find_intersect(x.point);if(ix)return ix;ix=_ginter.create(x.point);oe.gfx.intersect(ix);return ix}else return _ginter.create(x.point)});e.gfx=_gtour.create(e.l1,e.l2,intr)}function remove_edge_graphics(e){var ge=e.gfx;_ginter.remove_all(ge);
ge.close();_gtour.remove(ge);_rqueue.add_front(_ginter);_rqueue.add_front(_gtour);delete e.gfx;return ge}function locationState(l,add_edges){var e=_tour.edges(l);var count=e?e.length:0;if(add_edges)count+=add_edges;l.gfx.edge_count(count)}function scene_event_listener(evts){let changes=0;function single_event(ev){var g,loc=ev.location;switch(ev.action){case "scene_full":_target_size--;break;case "remove":_gtour.target_size(_scene.size());_gscene.target_size(_scene.size());loc.gfx.vanish();_gscene.remove(loc.gfx);
delete loc.gfx;changes++;break;case "add":_gtour.target_size(_scene.size());_gscene.target_size(_scene.size());loc.gfx=_gscene.create(loc);loc.gfx.appear(function(){test_autoconnect_loc(loc)});changes++;break;case "discard":_gtour.discard();_gscene.discard();break;case "resize":break;case "max_vehicles":for(var i=0;i<_scene.locs.length;i++){var l=_scene.locs[i];if(l.is_depot&&l.gfx)l.gfx.set_max_conn(ev.value*2)}break;default:}}for(var i=0;i<evts.length;i++)single_event(evts[i]);if(changes&&module.on_scene_change)module.on_scene_change(_scene,
_tour)}function tour_event_listener(evts){function tour_event(e){switch(e.action){case "remove":var ge=remove_edge_graphics(e.edge);if(["unlink","rewire","decross","auto","auto_loc"].indexOf(e.context)===-1){locationState(e.edge.l1);locationState(e.edge.l2);if(e.context==="merge"||e.context==="clear")ge.deleteMergeAnim(Math.random()*.5);else if(e.context!="silent")ge.deleteAnim()}break;case "add":create_edge_graphics(e.edge);if(e.hidden)e.edge.gfx.hide();break;case "connect":create_edge_graphics(e.edge);
if(e.context==="merge"){locationState(e.edge.l1);locationState(e.edge.l2);e.edge.gfx.appearMerge(Math.random()*.4)}else{if(e.context==="auto"||e.context==="auto_loc"){locationState(e.edge.l1);locationState(e.edge.l2)}e.edge.gfx.appear()}if(e.context==="auto_loc")test_autoconnect(e.edge);break;case "unlink":if(e.edge){if(!e.keep){create_edge_graphics(e.edge);e.edge.gfx.hide()}if(e.context!="silent")e.edge.gfx.unlinkAnim(e.location,function(){test_autoconnect(e.edge);locationState(e.edge.l1);locationState(e.edge.l2)})}locationState(e.location);
break;case "subtour":e.location.gfx.subtour(e.subtour,Math.random()*.2);break;case "decross":var e0=e.edges[0],e1=e.edges[1];create_edge_graphics(e0);create_edge_graphics(e1);new gfx.anim.Decross(e0.gfx,e1.gfx,function(){e0.l2.gfx.connectAnim();e1.l2.gfx.connectAnim();test_autoconnect(e0);test_autoconnect(e1)});break;default:}}for(var i=0;i<evts.length;i++)tour_event(evts[i]);if(module.on_tour_change)module.on_tour_change(_tour)}function actor_event_listener(evts){function actor_event(e){switch(e.action){case "remove":var ge=
remove_edge_graphics(e.edge);locationState(e.edge.l1);locationState(e.edge.l2);ge.deleteAnim();break;case "change_state":break;case "location_change":locationState(e.location,e.add_edges);break;case "hide_edge":if(e.edge.gfx){e.edge.gfx.hide();_rqueue.add_front(_ginter);_rqueue.add_front(_gtour)}break;case "show_edge":e.edge.gfx.show();_rqueue.add_front(_ginter);_rqueue.add_front(_gtour);break;case "stable_edge":test_autoconnect(e.edge);break;case "release_bend":e.edge.gfx.unlinkAnim(e.pos,function(){test_autoconnect(e.edge);
locationState(e.edge.l1);locationState(e.edge.l2)});break;default:}}for(var i=0;i<evts.length;i++)actor_event(evts[i])}function scene_actor_event_listener(evts){function actor_event(e){switch(e.action){case "add":_target_size++;break;case "remove":_target_size--;break;default:}}for(var i=0;i<evts.length;i++)actor_event(evts[i])}module.touchSheet=function(ev){if(_actor.active())_actor.release();var ptr=_sheet.ptr_event(ev);_actor.activate(ptr)};module.leaveSheet=function(ev){var ptr;if(ev)ptr=_sheet.ptr_event(ev);
else _sheet.ptr_event();if(_actor.active())_actor.release(ptr)};module.moveSheet=function(ev){var ptr=_sheet.ptr_event(ev);if(_actor.active())_actor.move(ptr)};module.resizeEvent=function(ev){_sheet.resize();var w=_sheet.width,h=_sheet.height;_scene.resize(w,h);$("current_size").innerHTML=_scene.size();_rqueue.add(_gtour);_rqueue.add(_gscene);_rqueue.add(_ginter)};var _initTimers=[];module.initDepot=function(){_scene.init_depot()};module.initRndLoc=function(){var time=Math.floor(Math.random()*400);
var tidx=_initTimers.length;var t=setTimeout(function(){_initTimers[tidx]=undefined;var l=_scene.add_random()},time);_initTimers.push(t)};module.rmRndLoc=function(){var time=Math.floor(Math.random()*400);var tidx=_initTimers.length;var t=setTimeout(function(){module.in_remove_op=true;_initTimers[tidx]=undefined;for(var tries=0;tries<20;tries++){var idx=Math.floor(Math.random()*_scene.size());if(!_scene.locs[idx].is_depot)break}var l=_scene.remove(idx);delete module.in_remove_op},time);_initTimers.push(t)};
module.stopInit=function(){for(var i=0;i<_initTimers.length;i++)if(_initTimers[i])clearTimeout(_initTimers[i]);_initTimers=[]};module.set_actor=function(act_type,callback){_actor.close();if(act_type=="scene"){_actor=new SceneActor(_scene,5);_actor.events.register(scene_actor_event_listener)}else if(act_type=="depot"){_actor=new DepotActor(_scene,function(){module.set_actor("tour");if(callback)callback()});_actor.events.register(scene_actor_event_listener)}else{_actor=new TourActor(_scene,_tour);_actor.events.register(actor_event_listener)}};
module.st_color=function(st){return _gscene.color(st)};module.clear_tour=function(){_tour.clear()};module.merge_tour=function(t){_tour.merge(t)};module.tour_locations=function(){return _tour.tour_locations()};module.tour_complete=function(){return _tour.complete()};module.tour_length=function(){return _tour.length()};module.cancel_anim=function(){_director.cancel();_rqueue.cancel()};module.set_vehicles=function(x){_scene.set_max_vehicles(x);_gscene.set_max_vehicles(x)};setup();module.sheet=_sheet;
module.scene=_scene;module.anim=anim;return module}var MAX_LOCS=99;var MIN_LOCS=5;var engine;var controls;var gfx;var anim;var _board;function tsp_setup(){var sheet=new Sheet("layers");anim=ANIM(sheet);gfx=GFX(anim);engine=TourEngine(sheet);engine.on_scene_change=function(scene,tour){update_size(scene);tour_change(tour)};engine.on_tour_change=tour_change;controls=Controls(engine);_board=new VRPBoard(anim,function(st){return engine.st_color(st)})}
function tsp_init(div){tsp_reset();controls.init(engine.sheet);init_buttons()}
function init_buttons(){controls.setup_button($("a_newgame"),tsp_reset);controls.setup_button($("a_edit"),tsp_switch_actor);controls.setup_button($("a_depot"),tsp_edit_depot);controls.setup_button($("a_fewer"),function(){tsp_rem_location(5)});controls.setup_button($("a_more"),function(){tsp_add_location(5)});controls.setup_button($("a_clear_all"),tsp_clear_all);controls.setup_button($("a_v_plus"),tsp_add_vehicle);controls.setup_button($("a_v_minus"),tsp_rem_vehicle);controls.setup_button($("d_vehicles"),
tsp_cycle_vehicles);controls.setup_button($("d_locs"),function(){tsp_add_location(1)})}function update_size(scene){$("current_size").innerHTML=scene.size();if(scene.size()>=5)_board.set_level(scene.size())}var _last_length=0;var _disable_board_updates;
function tour_change(tour){let stats=tour.subtour_stats();_board.set_stats(stats);if(!(_disable_board_updates||engine.in_remove_op))if(stats.valid&&_last_length){let diff=_board.scale_diff(stats.length,_last_length);_last_length=stats.length;var p=engine.sheet.pointer();if(!p)p=vec(engine.sheet.width/2,engine.sheet.height/2);new gfx.anim.Diff(diff,p)}else if(stats.valid)_last_length=stats.length;else _last_length=0}var _target_size;
function tsp_size(x){if(x<MIN_LOCS)x=MIN_LOCS;if(x>MAX_LOCS)x=MAX_LOCS;_target_size=x;if(engine.scene.size()==x)return;_board.set_level(x);engine.set_actor(_board.reset_actor());engine.stopInit();var addsize=x-engine.scene.size();for(var i=0;i<addsize;i++)engine.initRndLoc();for(var i=0;i<-addsize;i++)engine.rmRndLoc()}function tsp_add_location(x){if(!x)x=1;tsp_size(_target_size+x)}
function tsp_rem_location(x){_disable_board_updates=true;if(!x)x=1;tsp_size(_target_size-x);_disable_board_updates=false}
function tsp_reset(scidx){engine.stopInit();engine.cancel_anim();if(isSmall()){_target_size=10;_board.set_level(_target_size)}_disable_board_updates=true;_board.reset();_board.reset_actor();engine.set_actor(_board.actor_type());engine.scene.clear();engine.sheet.wipe_clean();if(isPhone())window.scrollTo(0,1);engine.initDepot();_target_size=_board.level;for(var i=0;i<_board.level;i++)engine.initRndLoc();_disable_board_updates=false}function tsp_clear_all(){engine.clear_tour()}
function tsp_edit_depot(){engine.set_actor(_board.switch_depot(),function(){_board.set_depot()})}function tsp_add_vehicle(){engine.set_vehicles(_board.add_vehicle())}function tsp_rem_vehicle(){engine.set_vehicles(_board.rem_vehicle())}function tsp_cycle_vehicles(){engine.set_vehicles(_board.cycle_vehicles())}function tsp_switch_actor(){engine.set_actor(_board.switch_actor())}function tsp_language(x){init_language(x)}
function init_language(x){if(x==null)LANGUAGE=detect_language();else LANGUAGE=x;var node_text={"a_newgame":"RESET BOARD","tx_edit":"edit","tx_fewer":"fewer","tx_more":"more","tx_v_plus":"more","tx_v_minus":"fewer","tx_locations":"Locations","tx_vehicles":"Vehicles","tx_depot":"depot","clear_text":"clear all connections","tx_length":"tour&nbsp;length","tx_length_s":"length","tx_valid":"Solution is invalid","tx_valid_s":"invalid solution"};for(var id in node_text)$(id).innerHTML=tr(node_text[id])};
